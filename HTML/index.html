<!doctype html>
<html>
<head>
 
<title>AIS-catcher</title>

<meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0,maximum-scale=1.0, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes">
<link rel="apple-touch-icon" href="favicon.ico">

<script src="https://kit.fontawesome.com/296bfd8db6.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/rbush@3.0.1/rbush.min.js"></script>	

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/lipis/flag-icons@6.6.6/css/flag-icons.min.css" />
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js" integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>

<style>
    :root {
        --primary-color: #0857b1;
        --secondary-color: #12a5ed;
        --tertiary-color: #0b1033;
        --panel-color: #f2f8ff;
        --ok-color: rgb(129, 244, 129);
        --error-color: red;
        --header-color: var(--primary-color);
        --header-title-color: #0e6cd8;
        --selection-color: orange;
        --mainspace-color: white;
        --backdrop-color: #f5f7fa;
        --focus-color: red;
        --light-gray: lightgray;
        --header-font-color: white;
        --menu-background-color: white;
        --menu-background-hover-color: #daebfe;
        --menu-font-color: rgb(66, 66, 66);
        --mainspace-container-color: lightgrey;
        --table-header-background-color: var(--primary-color);
        --table-background-color: white;
        --table-selection-background-color: #daebfe;
        --table-alternate-background-color: var(--panel-color);
        --main-font-color: var(--tertiary-color);
        --shipcard-footer-background-color: var(--tertiary-color);
        --shipcard-footer-hover-color: var(--primary-color);
        --shipcard-selection-color: rgb(240, 241, 248);
        --shipcard-bottom-border-color: rgb(217, 218, 218);
        --chart1-color: rgba(93, 169, 213, 0.9);
        --chart2-color: rgba(157, 93, 213,0.9);
        --chart3-color: rgba(93, 213, 97,0.9);
        --chart4-color: rgba(213, 157, 93,0.9);
        --chart5-color: rgba(93, 213, 154,0.9);
        --hover-transform: scale(0.93);
        --hover-transition: transform ease-out 0.2s, background 0.4s;
        --hover-background: rgba(255, 255, 255, 0.5);
        --graph-header-color: white;
    }

    .dark {
        --primary-color: #5DD5D5;
        --secondary-color: #FFA07A;
        --tertiary-color: #05081f;

        --panel-color: black;
        --ok-color: #7ce481;
        --error-color: #ec7472;
        --header-color: rgb(69, 3, 69);
        --header-title-color: purple;
        --selection-color: #9fa8da;
        --mainspace-color: #212529;
        --backdrop-color: black;
        --focus-color: #90caf9;
        --light-gray: lightgray;
        --header-font-color: #f8f9fa;
        --menu-background-color: black;
        --menu-background-hover-color: #4d4d4d;
        --menu-font-color: #f8f9fa;
        --mainspace-container-color: #212529;
        --table-header-background-color: #014f4a;
        --table-background-color: black;
        --table-selection-background-color: purple;
        --table-alternate-background-color: rgb(27, 0, 27);
        --main-font-color: white;
        --shipcard-footer-background-color: #014f4a;
        --shipcard-footer-hover-color: var(--secondary-color);
        --shipcard-selection-color: rgb(41, 40, 40);
        --shipcard-bottom-border-color: var(--header-color);
        --chart1-color: rgba(158, 226, 255, 0.9);
        --chart2-color: rgba(255, 158, 158, 0.9);
        --chart3-color: rgba(158, 255, 174, 0.9);
        --chart4-color: rgba(255, 219, 158, 0.9);
        --chart5-color: rgba(158, 255, 239, 0.9);
        --hover-background: rgba(255, 255, 255, 0.1);
        --graph-header-color: rgb(27, 0, 27);
    }

    body,
    html {
        height: 100%;
        width: 100%;
        margin: 0;
        font-family: Arial;
        display: flex;
        flex-direction: column;
        justify-content: stretch;
        -webkit-user-select: none;
        -ms-user-select: none;
        user-select: none
    }

    .header {
        background: var(--header-color); 
        flex: 0 0 40px;
        font-size: 20px;
        display: flex;
        justify-content: stretch;
        color: white; 
    }


    .header-title {
        flex: 1;
        background-color: var(--header-title-color);
        border-top-right-radius: 25% 50%;
        border-bottom-right-radius: 25% 50%;     
        display: flex;
        flex-direction: row;
    }

    .header-title span {
        padding: 15px;
        line-height: 20px;
        padding-right:50px;
    }

    .header-title div {
        padding: 15px;
        background: var(--header-color); 
        margin: auto 0;
        border-radius: 20px;
        font-size: 15px;
        line-height: 15px;     
        padding: 10px 15px;
    }
        
    @media only screen and (max-width:750px) {
        .header-title div
         {
            display: none;
        }
    }

    .header-title div.show {
        display: none;
    }

    .header-title div i {
        padding: 0px 20px;
        transition: var( --hover-transition);
    }

    .header-title div i:hover {
        cursor: pointer;
        transform: var(--hover-transform);
    }

    .header-title div i.active {
        color: var(--secondary-color);
    }

    .header-icon, .header-pulse-ok, .header-pulse-error {
        width: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: var( --hover-transition);
        font-size: 15px;
        line-height: 15px;     
    }

    .header-pulse-ok {
        color: var(--ok-color);
    }

    .header-pulse-error {
        color:  var(--error-color);
    }

    .header-icon:hover {
        cursor: pointer;
        transform: var(--hover-transform);
    }

    .fs-icon-normal:before {
        content: "\f424";
        font-family: "FontAwesome";
    }

    .fs-icon-full:before {
        content: "\f066";
        font-family: "FontAwesome";
    }

    .header-menubutton {
        background: var(--menu-background-color);
        color: var(--menu-font-color);
        display: block;
        transition: var( --hover-transition);
        font-size: 18px;
        padding-top: 15px;
        width: 40px;
        text-align: center;
    }

    .header-menubutton:hover {
        cursor: pointer;
    }

    .bottombar {
        flex: 0 0 15px;
        background: var(--tertiary-color)
    }

    #menubar {
        z-index: 9999; 
        background: var(--menu-background-color);
        color: var(--menu-font-color);
        text-align: center;
        align-items: stretch;
        display: none;
        flex-direction: row;
        visibility: visible;
    }

    @media only screen and (min-width : 750px) {
        #menubar {        
            position: fixed; 
            top: 60px; 
            left: 10px; 
            right: 0;
            width: 500px;
            border: solid;
            border-color: lightgrey;
            border-radius: 20px;
        }
    }    

    #menubar div
    {
        flex: 0 1 150px;
        margin: 0 10px;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: var( --hover-transition);
        display: flex;
        flex-direction: column;
    }

    #menubar div i
    {
        padding-top: 10px;
        padding-bottom: 10px;
        font-size: 20px;
        line-height: 20px;
    }

    #menubar div span
    {
        padding-bottom: 10px;    
        font-size: 10px;
        line-height: 10px; 
    }

    #menubar div:hover {
        background: var(--menu-background-hover-color);
        transform: var(--hover-transform);
    }

    #menubar div.active {
        border-bottom: 4px solid var(--secondary-color);
        color: var(--secondary-color);
    }

    #menubar.visible {
            display: flex;
    }

    .mainspace-container {
        flex: 1 0 0;
        overflow: auto;
        background: var(--backdrop-color);
        border-top: solid;
        border-color: var(--mainspace-container-color);
        border-width: 4px;
        display: flex;
        flex-direction: column;
        justify-content: stretch;
    }

    .mainspace {
        background: var(--mainspace-color);
        margin: 20px;
        flex: 1;
        border: 1px;
    }

    @media only screen and (max-height : 1000px) {
        .menubar {
            display: flex;
        }

        .header-menubutton {
            display: block;
        }

        .bottombar {
            display: none;
        }

        .mainspace {
            margin: 5px;
        }
    }

    /* Plot styling */
    .graphtab {
        padding: 15px;
        display: grid;
        grid-template-columns: 1fr 1fr 1fr 1fr;
        column-gap: 15px;
        row-gap: 15px;
    }
    
    @media only screen and (max-width:2250px) {
        .graphtab {
            grid-template-columns: 1fr 1fr 1fr;
            padding: 5px;
        }
    }

    @media only screen and (max-width:1500px) {
        .graphtab {
            grid-template-columns: 1fr 1fr;
            padding: 5px;
        }
    }

    @media only screen and (max-width:800px) {
        .graphtab {
            grid-template-columns: 1fr;
            padding: 0px;
        }
    }

    .graph-panel {
        padding: 10px;
        overflow: auto;
        background-color: var(--panel-color);
        border-radius: 15px;
    }
    

    .graph-panel > header {
        margin: 20px auto 30px auto;
        padding: 5px 0px;
        border-radius: 10px;

        max-width: 400px;
        width: calc(100% - 30px);
        
        align-items: center;
        border-left: 10px solid lightgray;
        border-right: 10px solid lightgray;

        background-color: var(--secondary-color);
        color: var(--graph-header-color);
        
        text-align: center;
        font-size: 1.0em;
    }

    .graph-panel > canvas {
        width: 100%;
        height: 100%;
    }

    .aboutpage {
        background-color: var(--backdrop-color);
        color: var(--main-font-color);
    }

    /* Table styling */

    .tablesection {
        font-size: .8em;
        display: flex;
        height: 100%;
        margin: 10px auto;
        color: var(--main-font-color);
        background-color: var(--table-background-color);
        width: fit-content;

    }

    table {
        height: 100%;
        min-width: 1300px;
        overflow: auto;
        border-collapse: collapse;
    }

    table thead tr th:nth-child(1),
    table tbody tr td:nth-child(1) {
        text-align: left;
        width: 220px;
    }

    table thead tr th:nth-child(3),
    table tbody tr td:nth-child(3) {
        text-align: left;
        width: 65px;
    }

    table thead tr th:nth-child(10),
    table thead tr th:nth-child(11),    
    table tbody tr td:nth-child(10),
    table tbody tr td:nth-child(11) 
    {
        text-align:right;
        width: 90px;        
    }

    table thead tr th:nth-child(2),
    table thead tr th:nth-child(4),
    table thead tr th:nth-child(5),
    table thead tr th:nth-child(6),
    table thead tr th:nth-child(7),
    table thead tr th:nth-child(8),
    table thead tr th:nth-child(9),
    table thead tr th:nth-child(12),
    table thead tr th:nth-child(13),
    table tbody tr td:nth-child(2),
    table tbody tr td:nth-child(4),
    table tbody tr td:nth-child(5),
    table tbody tr td:nth-child(6),
    table tbody tr td:nth-child(7),
    table tbody tr td:nth-child(8),
    table tbody tr td:nth-child(9),
    table tbody tr td:nth-child(12),
    table tbody tr td:nth-child(13),
    {
        text-align:right;
        width: 45px;
    }

        table thead {
            background-color: var(--table-header-background-color);
            font-size: 1em;
            color: white;
        }

            table thead > tr > th {
                padding: 25px 15px;
                border-collapse: collapse;
                transition: var(--hover-transition);
            }

            table > thead > tr > th:after {
                content: " \f0dc "; 
                font-family: "Font Awesome 5 Free"; 
                font-weight: 900;
                color: lightgray;
            }

            table > thead > tr > th:hover {
                background: var(--hover-background);
                transform: var(--hover-transform);
                cursor: pointer;
            }

        table tbody th,
        td {
            border: dashed thin;
            border-color: lightgrey;
            padding: 10px 15px;            
        }

        table > tbody > tr > td[valid="Pending"],
        table > tbody > tr > td[valid="No"] 
        {           
            color: red;
        }

        table > tbody > tr > td[valid="Yes"] {
            color: green;
        }

        table > tbody >tr:nth-child(even) {
                background: var(--table-alternate-background-color);
            }

        table > tbody >tr:hover {
            background: var(--table-selection-background-color);
        }

    .table-aligned-center {
        text-align: center
    }

    .selectable {
        color: var(--selection-color);
    }

    /* Map styling */ 

    #map {
        height: 100%;
        width: 100%;
    }

    .maptab {
        height: 100%;
    }

    .shiptable-map {
        width: 10px;
    }

    .shipicon {
        background: url("data:image/png;base64,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");
        width: 20px;
        height: 20px;
        opacity: 1;
        display: inline-block;
    }

    .staticon {
        background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAAUCAYAAADRA14pAAACXUlEQVRYhe3Ru47aQABG4UMWKSGJUJRqW9JlN+yKJim59duQBwD2kShyqXBtkheghJ4KF0gICewCISxRMgg7BYYYe2ZtME0uI42EMDr6Pwz/j/S8A1L/Su9+MGCmaXy5UPQeBjPQLtYbwEzjMvvuDAPTdXGFYKNpfE0YvQPDBNcFsQEtcc8A0wVXwEYj2b68YWC5Lu7+JkTnwbB22P1NhM4bYPliidAfglgJ+tkpvTA2hD6pF8RK0LF7SmwA/S1m9AnsETp2T4UNoGP1bqOwfnS7HRm9jcb60e3IXhTWj25HoG9k2NGIZb9PazhkokB/V0Rv5NjREvotGE4UaGVPhh3Bsg+tIUwUaGnvvQy73SIKBR6833xarRAStPDQV/6eHLsVUDj0YCUkaOGhj3oy7BZEAd8+EBK08NBX7OW1GtfZLC8k/6qby/Ha+/wmlcIN/iCdhkyGt8Dz/XcpateQlfYgd+hBKtSDNJA56n2G6yyKffj2IdkHZDjeB0C9TtU0sYNv0LKwez264zGL4DPHQeg6P4GX4S31Kph2+A1aNvS6MF6EnzkCdGmvDlUT7OAbtMDuQXcMi+AzB4SOah/QaFCRoWXXw/5QxnbFihwtu44A/cleAyoytOx62Ih9MdHxsKego7GnoGNj96fZpKxCe9hO7NiuWFajHQH6Sb0mlFVoD3vivh26FEQ7DutO54zYrlgKo501dM7qNaEURDuw7pyDPUR9aA+rA6/Oiu2Kpd9oZw2dRD0/2sMm3Ac8PlKcTpknxx6KRZjOk2IPNShOYX4RrO98vGTsD+j9PecXIj9PVcetObkAAAAASUVORK5CYII=");
        width: 20px;
        height: 20px;
        opacity: 1;
        display: inline-block;
    }

    .planeicon {
        background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAACt0lEQVRIx7XVT2hcVRTH8c9MJ5kwo5kEkv5Bilpr20j8E62xCyHZuHGhIM1CaXfWTUGoglpQF+rGZRE3BRVpEaSC1V2oGxcVsVhEIYZYK60UkyZmZpJmMs1k3nXhDQzTRidt8oPL475zzv3ec96959G6XkHYLl1FwKs2QD/t1zlf9uTkfp3z+Hm9Ae1YHNVfDobDGf0lVJFrJTjdImQ7Ou6Tq0F8ZnHPekKy0Ks9A1tlM2spQ3otzlnp8G9QyoZBblWtQB7Cx6vYTuCx29lAG97GEmof2TlZN1QNhkPdUPWE+yexHO3vRP81aQDnEZ7TWbxgcDIYDs3jd4N/HdA9Fy/n+Rh3g1I3uQ9v4nVkTto1PWJroV26Y7XdLEmqp0yWD5jojZm9j/dihjdA9uJTPPCCrrl37arukNvcauoXVa6+ZaLjM6VOjOEQvluBtEXyEaRO2VN81pZ8m1QOSdly+aJKeyKkd8qHgkxuzvLCbxbSaalkh9xSQaaAdE2ofGVqYcR4VzxUH+Ao/IpwUHfxkiemaoYq4x6f+cKe4vO6SrHeAeGcgcVgOJwzsNj4fkSh9Lnds2P2TtcMVa7YN/uSntlo/wXqL9s8dlrflaO2Xc1LrXTZ6/g2fqNHMNEEmcLDeC36LSLkpapv2DZzWt/lw3rHUYekYVcX8CGeQWdT2cdG9U8Hw+EbD87Eujfqzhh3LK6zsmaSiRftB5zBpQi9mUo1SQ9U1RNca7LP4+s4juBuPIXBDF5s8QCVm+Z//4dvgj9wHMfX1LtKlvNQUc9uVIMsBiEN1yXt8ae1rpAM7m16txs96wXZhE+w7w6ZGmyRXUAfRtHVygL/p2M49LT8nwfdJaFekNmUVb981rV+PIovUbvVdn+44bzXELqlluK82mA7eTvlamzdY/ixKLThe5yNADGbVfUPx0b/bFzy3uUAAAAASUVORK5CYII=");
        width: 25px;
        height: 25px;
        opacity: 1;
        display: inline-block;
    }

    .helicoptericon {
        background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAADxUlEQVRIx61VXWgcVRg9d+7Mnd3Zmd1N405oE5KakLbYgDTFH5BUEFo1WJuUNkiLEkVFxSb4UEVsUCutbWPAH1y10qAP2tJa6kMJltKU+CDqKmxQMNZV2ZikSkKSNTP7Mz97fcnCMuxuNq3n8Z7vO+fe7565A6wOr3wSDM5up/RL3AS2UuAogJoSXPiYovwV13V+OhRaAnBvGY37KPAmAFJYEDwFzW+r6r49ongRQJ2H69zq96sAsFGW6TrgwRIGe48oyqdPMdZVyeTcAcOIdvh8Db2S9BWAhgJRA2yIUBpcbvL3+nxtnt7HBwOBwWnHSX1oWT0A8uVMAOBEv2Gc2MyY9jRjlwC0AMB+xjYW10cobS/a7fNDgcDAhGWlopbVBeCnYkGhzFzfP2iabzSJotQny5cAtNWLYlNxwS2iuGb57l5+V1UP/pjLzZ6y7YcAJLxitEIIxkdte+ZhWd7VLgjddaJY3yhJSoHMcb54JZttf0vT9n6dzSbPOE4XgJlSQnSFtP0yats/389Y13ZVrSNFJw8IArmbMe28aV674Lq7AMyVExFWMFkPoHHOdVPEsyGREH8mn1cuuu73ABqL0+QFKeO8+5Dff6iVsfVNkiQHBUEpJ5DjPDdt2/nfLOvvkWz2s7F8fsBbI5ZqfEKStu3WtC3VfL0yIXIzY2hm7FZFELrHDKM6k89t+1pbOp3QKQ01SVIgUOEkNufmjOPwSdv+N5bLjVc9riJsALDvPVXt71CUcIlRzW2bnU3mgD4AMQD2jVy8uV8UOzmQOT4/H8sD2QJxfmkpNriw8PuQqq7VgZ0AnBt5LFselaTYUCCQBHAAwCNXa2sX47rO47rOd1IaBaB1Uno5qml/rAPeKTf+critj7GJo4ryK4Dewui+CIdTcV3nP0QiBoD+5XXfPYJw4aSmJbcQMlytUfsLspw4oihTAHqK1tWPNG0xrut8tLZ2EcCe4pDdQcjpU8HgP3cKwjkAcsX/yYs+X+J1v38SQKeXPKYo38V1nZ8Nh1MAWr1JvZ2Q4Y81bXIHpSOVnvqWaceZfzWTeQzAiNfkuutOAsC860oAkh7aGef8ycOGcSZMSH0VoSqNTYS8Ftf1/HFF+WY1fatym+B8Lsu5Ne26U6vpqyYJzwIgD1DasFkUO1zOxRpB2PQcYx9ELetPAD4AhysJkBUdGBvuDYW6ZUJC3nqHc/OKaV5/KZ1uvamTcCD/bSZjraHU0CmlEVGUFlzXnHddOmXbbppzEf8DegCMAVgLYMddgpAA8AyAZgADAE6uJPAfk1U+b+R6xyUAAAAASUVORK5CYII=");
        width: 25px;
        height: 25px;
        opacity: 1;
        display: inline-block;
    }

    /* Shipcard styling */
    #shipcard {
        top: 10px;
        left: 10px;
        width: 400px;
        display: flex;
        flex-direction: column;
        justify-content: stretch;
        z-index: 9998;
        position: absolute;
        visibility: hidden;
        background: var(--menu-background-color);
        color: var(--menu-font-color);
        cursor: auto;
        border-radius: 15px;
    }

        #shipcard.visible {
            visibility: visible
        }

    #shipcard_content {
        flex: 1;
        overflow: auto
    }

    #shipcard_header {
        flex: 0 0 35px;
        padding: 10px;
        margin: 5px;
        margin-top: 10px;
        border-radius: 10px;
        line-height: inherit;
        align-items: center;
        font-size: 18px;
        color: white;
        background-color: var(--secondary-color);
        display: flex;
        flex-direction: row;
        justify-content: stretch;
    }

    .shipcard-validated {
        border-left: 10px solid #7CFC00;
    }

    .shipcard-not-validated {
        border-left: 10px solid lightgrey;
    }

    .shipcard-dubious {
        border-left: 10px solid red;
    }

    .shipcard-not-validated-transparant {
        border-left: 10px solid transparent;
    }

    .shipcard-footer {
        background-color: var(--shipcard-footer-background-color);
        border-bottom: 1px solid rgb(217, 218, 218);
        flex: 0 0 50px;
        border-radius: 10px;
        display: flex;
        flex-direction: row;
        margin: 5px;
        margin-bottom: 10px;
        justify-content: center;
    }

        .shipcard-footer > div {
            flex: 0 1 100px;
            display: flex;
            flex-direction: column;
            border-radius: 10px;
            transition: var( --hover-transition);
        }

            .shipcard-footer > div:hover {
                cursor: pointer;
                background: var(--hover-background);
                transform: var(--hover-transform);
            }

            .shipcard-footer > div > i {
                color: white;
                font-size: 17px;
                line-height: 17px;
                margin: auto;
                padding: 10px;
            }

            .shipcard-footer > div > span {
                flex: 1;
                font-size: 9px;
                line-height: 3px;
                color: white;
                text-align: center;
            }

    #shipcard header > span:first-child {
        flex: 1 0 0;
    }

    .shipcard-header-icon {
        flex: 0 1 0;
        padding: 5px;
        border-radius: 10px;
        line-height: 10px;
        transition: var( --hover-transition);
    }

        .shipcard-header-icon:hover {
            cursor: pointer;
            background: var(--hover-background);
            transform: var(--hover-transform);
        }

    #shipcard_content {
        display: flex;
        flex-direction: column;
    }

    .shipcard-content-row {
        display: flex;
        flex-direction: row;
        justify-content: stretch;
        padding: 10px;
        border-bottom: 1px solid var(--shipcard-bottom-border-color);
        transition: var( --hover-transition);
    }

        .shipcard-content-row:hover {
            cursor: pointer;
        }

        .shipcard-content-row > div {
            overflow: hidden;
            flex: 1;
            display: flex;
            justify-content: stretch;
            flex-direction: column;
        }

            .shipcard-content-row > div > span:first-child {
                color: rgb(111, 128, 124);
                text-transform: uppercase;
                font-size: 10px;
                line-height: 14px;
            }

            .shipcard-content-row > div > span:last-child {
                line-height: 20px;
                font-size: 14px;
                text-transform: initial;
            }

                .shipcard-content-row > div > span:last-child:empty:after {
                    content: "-";
                }

    .shipcard-min-only {
        display: none;
    }

        .shipcard-min-only.visible {
            display: inherit;
        }

    .shipcard-max-only.hide {
        display: none;
    }

    .shipcard-row-selected {
        background-color: var(--shipcard-selection-color);
        display: flex;
        flex-direction: row;
    }

    @media only screen and (max-width:500px) {
        #shipcard {
            width: 100%;
            left: 0;
            top: 0;
            border-radius: 0px;
        }
        #shipcard header {            
            font-size: 14px;
        }
    }

    @media only screen and (max-height:800px) {
        .shipcard-ismax {
            height: 100%
        }
        #shipcard {
            left: 0;
            top: 0;
            border-radius: 0px;
        }
        #shipcard header {            
            font-size: 14px;
        }
    }

    .pulse {
        animation: pulsate 1s ease-out;
        animation-iteration-count: infinite;
        -webkit-animation: pulsate 1s ease-out;
        -webkit-animation-iteration-count: infinite;
        opacity: 0.25;
    }

    @keyframes pulsate {
        0% {
            transform: opacity 0.25;
        }

        50% {
            opacity: 1.0;
        }

        100% {
            transform: opacity 0.25;
        }
    }

    .leaflet-control-layers-toggle,
    .leaflet-control-label-toggle,
    .leaflet-control-station-toggle,
    .leaflet-control-zoom-in,
    .leaflet-control-zoom-out,
    .label-toggle-control {
        font-size: 18px;
        background-color: white;
        min-width: 30px;
        min-height: 30px;
        max-width: 30px;
        max-height: 30px;
    }

    .leaflet-control-label-toggle,
    .leaflet-control-station-toggle {
        text-align: center;
        color: grey;
        transform: translate(200px 0)
    }

    /* Summary tab */

    #summary_stat {
        max-width: 700px;
        margin: 15px auto ;        
        border-radius: 15px;
        background-color: var(--panel-color);
    }
    #summary_stat section {
        margin-bottom: 10px;
        padding: 10px;
        margin: 0 auto ;
    }
    #summary_stat section div {
        display: flex;
    }

        #summary_stat section div span:first-child {
            flex: 1 1 150px;
            text-align: right;
            color: var(--main-font-color);
            padding: 5px 20px 5px 20px;
            display: flex;
            flex-direction: column
        }
    #summary_stat section div span:last-child {
        flex: 1 0 150px;
        text-align: left;
        color: var(--primary-color);
        padding: 5px 20px 5px 20px;
        font-weight: 550;
        overflow-x: auto;
        border-left: solid 1px lightgray;
    }

    #summary_stat section div span:last-child:empty:after {
        content:"-";
    }

    @media only screen and (max-width:750px) {
        .leaflet-tooltip {
            font-size: 8px;
            padding: 3px;
        }
    }
   
    .blue {
        color: #12a5ed;
    }

    .green {
        color: green;
    }

    .red {
        color: red;
    }

    .grey {
        color: dimgray;
    }

    .lightgrey {
        color: lightgrey;
    }

    #context-menu {
        position: absolute;
        display: none;
        background-color: var(--menu-background-color);
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        list-style-type: none;
        padding: 8px 0;
        z-index: 10000;
        font-size: 14px;
        color: var(--menu-font-color);
        width: auto;
        margin: 0;
    }

        #context-menu li {
            display: flex;
            align-items: center;
            height: 24px;
            margin: auto;
            padding: 0 16px;
            cursor: pointer;
            white-space: nowrap; /* Prevent wrapping */
        }

        #context-menu .divider {
            height: 1px;
            background-color: #ccc;
            margin: 0.5rem 0;
            pointer-events: none;
        }

        #context-menu li:hover {
            background-color: var(--menu-background-hover-color);
        }

        #context-menu i {
            margin-right: 8px;
            font-size: 16px;
            width: 16px;
        }

        #context-menu .dynamic-item {
            color: #666;
        }

            #context-menu .dynamic-item:hover {
                background-color: transparent;
            }

    .submenu {
        position: relative;
    }

    .submenu-items {
        position: absolute;
        display: none;
        left: 100%;
        top: 0;
        background-color: var(--menu-background-color);
        border: 1px solid #ccc;
        border-radius: 5px;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        list-style-type: none;
        padding: 8px 0;
        z-index: 10000;
        font-size: 14px;
        color: var(--menu-font-color);
        width: auto;
        margin: 0;
    }

        .submenu-items li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 24px;
            margin: auto;
            padding: 0 16px;
            cursor: pointer;
            white-space: nowrap;
        }


            .submenu-items li:hover {
                background-color: var(--menu-background-hover-color);
            }

    .submenu:hover .submenu-items {
        display: block;
    }

    .marker {
        display: inline;
        margin-left: 16px;
        color: var(--menu-marker-color);
    }

    .selected-setting .marker {
        display: inline;
    }

/* Existing styles... */

.hidden {
    display: none;
}

#dialog-box {
    position: fixed;
    width: 300px;
    background-color: var(--menu-background-color);
    color: var(--menu-font-color);
    border: 1px solid #ccc;
    border-radius: 5px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    padding: 20px;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    z-index: 10001;
}

.dialog-title {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 10px;
}

.dialog-message {
    font-size: 14px;
    user-select: text;
    margin-bottom: 20px;
    overflow-y: auto;
    box-sizing: border-box; 
}

.dialog-close {
    background-color: var(--menu-background-hover-color);
    border: none;
    color: var(--menu-font-color);
    padding: 8px 16px;
    text-align: center;
    text-decoration: none;
    display: inline-block;
    font-size: 14px;
    margin: 4px 2px;
    cursor: pointer;
    border-radius: 4px;
}


</style>

<link rel="stylesheet" href="config.css">
</head>

<body>

    <div class="header">
        <div onclick="toggleMenu()" class="header-menubutton"><i id="header_menu_button" class="fa-solid fa-bars"></i></div>
        <div class="header-title">
            <span onclick="headerClick()">AIS-catcher</span>

            <div id="menubar_mini">
                <i id="stat_tab_mini" onclick="activateTab(event,'stat')" class="fa-solid fa-briefcase"></i>
                <i id="plots_tab_mini" onclick="activateTab(event,'plots')" class="fa-solid fa-chart-simple"></i>
                <i id="ships_tab_mini" onclick="activateTab(event,'ships')" class="fa-solid fa-table"></i>
                <i id="map_tab_mini" onclick="activateTab(event,'map')" class="fa-solid fa-map"></i>
                <i id="about_tab_mini" onclick="activateTab(event,'about')" class="fa-solid fa-circle-info"></i>
            </div>

        </div>

        <div title="Toggle Dark/Light mode" onclick="toggleDarkMode()" class="header-icon"><i id="darkmodetoggle-id" class="fas fa-moon"></i></div>
        <div title="List installed plugins" onclick="showPlugins()" class="header-icon"><i class="fas  fa-wrench fa-sm"></i></div>
        <div title="Toggle full screen mode" onclick="toggleScreenSize()" class="header-icon"><i id="screentoggle-id" class="fas fs-icon-normal fa-sm"></i></div>
        <div title="Connection status with server" id="pulse-id" class="header-pulse-ok"><i class="fa-solid fa-link fa-sm"></i></div>

    </div>
    <nav id="menubar">
        <div onclick="activateTab(event,'stat')" id="stat_tab"><i class="fa-solid fa-briefcase"></i><span>Summary</span></div>
        <div onclick="activateTab(event,'plots')" id="plots_tab"><i class="fa-solid fa-chart-simple"></i><span>Plots</span></div>
        <div onclick="activateTab(event,'ships')" id="ships_tab"><i class="fa-solid fa-table"></i><span>Ships</span></div>
        <div onclick="activateTab(event,'map')" id="map_tab"><i class="fa-solid fa-map"></i><span>Map</span></div>
        <div onclick="activateTab(event,'about')" id="about_tab"><i class="fa-solid fa-circle-info"></i><span>About</span></div>
    </nav>
    <div class="mainspace-container">
        <div  oncontextmenu="showContextMenu(event,0,[])" class="mainspace">

            <ul id="context-menu">
                <li class="submenu">
                    <i class="fas fa-cog"></i>Settings
                    <ul class="submenu-items">
                        <li id="setting1" onclick="selectSetting(1)">Not implemented yet<span class="marker"><i class="fas fa-check"></i></span></li>
                    </ul>
                </li>
                <li class="divider mmsi"></li>
                <li class="mmsi-map"><i class="fas fa-crosshairs"></i>Pin to center</li>
                <li class="mmsi-map" onclick="mapResetView(13,context_mmsi)"><i class="fas fa-bullseye"></i>Focus</li>
                <li class="mmsi-map" onclick="showShipcard(context_mmsi)"><i class="fas fa-ship"></i>Show Shipcard</li>
                <li class="divider mmsi-map"></li>
                <li class="mmsi" onclick="showNMEA(context_mmsi)"><i class="fas fa-envelope"></i>Show Last Message</li>
                <li class="mmsi" onclick="copyMMSI(context_mmsi)"><i class="fas fa-copy"></i>Copy MMSI</li>
                <li class="mmsi" onclick="copyCoordinates(context_mmsi)"><i class="fas fa-clipboard"></i>Copy Coordinates</li>
                <li class="divider mmsi"></li>
                <li class="mmsi" onclick="openGoogleSearch(context_mmsi)"><i class="fab fa-google"></i>Search on Google</li>
                <li class="mmsi" onclick="openMarineTraffic(context_mmsi)"><i class="fab fa-m"> </i>Find on MarineTraffic</li>
                <li class="mmsi" onclick="openVesselFinder(context_mmsi)"><i class="fab fa-v"></i>Find on VesselFinder</li>
                <li class="mmsi" onclick="openShipXplorer(context_mmsi)"><i class="fab fa-s"></i>Find on ShipXplorer</li>
            </ul>

            <div id="dialog-box" class="hidden">
                <div class="dialog-title">Dialog Title</div>
                <div class="dialog-message">This is the message area.</div>
                <button class="dialog-close" onclick="closeDialog()">Close</button>
            </div>

            <div class="tabcontent" id="about">
                <div class="aboutpage" id="about_content"></div>
            </div>
            <div class="tabcontent" id="stat">
                <div id="summary_stat">
                    <section>
                        <div>
                            <span>Station</span><span id="stat_station"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Device</span><span id="stat_product"></span>
                        </div>
                        <div>
                            <span>Vendor</span><span id="stat_vendor"></span>
                        </div>
                        <div>
                            <span>Serial</span><span id="stat_serial"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Version</span><span id="stat_build_describe"></span>
                        </div>
                        <div>
                            <span>Build date</span><span id="stat_build_date"></span>
                        </div>
                        <div>
                            <span>Engine</span><span id="stat_model"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Sampling rate</span><span id="stat_sample_rate"></span>
                        </div>
                        <div>
                            <span>Data processed</span><span id="stat_received"></span>
                        </div>
                        <div>
                            <span>Running time</span><span id="stat_run_time"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Total messages</span><span id="stat_stat_count"></span>
                        </div>
                        <div>
                            <span>Last day</span><span id="stat_last_day_count"></span>
                        </div>
                        <div>
                            <span>Last hour</span><span id="stat_last_hour_count"></span>
                        </div>
                        <div>
                            <span>last minute</span><span id="stat_last_minute_count"></span>
                        </div>
                        <div>
                            <span>Rate</span><span id="stat_msg_rate"></span>
                        </div>
                        <div>
                            <span>Vessels seen</span><span id="stat_vessel_count"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Channel A</span><span id="stat_stat_channel0"></span>
                        </div>
                        <div>
                            <span>Channel B</span><span id="stat_stat_channel1"></span>
                        </div>
                        <div>
                            <span>Channel C</span><span id="stat_stat_channel2"></span>
                        </div>
                        <div>
                            <span>Channel D</span><span id="stat_stat_channel3"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Class A position</span><span id="stat_stat_msg123"></span>
                        </div>
                        <div>
                            <span>Class A static</span><span id="stat_stat_msg5"></span>
                        </div>
                        <div>
                            <span>Class B position</span><span id="stat_stat_msg1819"></span>
                        </div>
                        <div>
                            <span>Class B static</span><span id="stat_stat_msg24"></span>
                        </div>
                    </section>
                    <section>
                        <div>
                            <span>Base station</span><span id="stat_stat_msg4"></span>
                        </div>
                        <div>
                            <span>SAR aircraft</span><span id="stat_stat_msg9"></span>
                        </div>
                        <div>
                            <span>Aid-to-Navigation</span><span id="stat_stat_msg21"></span>
                        </div>
                        <div>
                            <span>Other</span><span id="stat_stat_msgother"></span>
                        </div>
                    </section>
                </div>
            </div>

            <div class="tabcontent" id="plots">
                <div class="graphtab">
                    <div class="graph-panel">
                        <header>Messages per Second</header>
                        <canvas id="chart-seconds"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Messages per Minute</header>
                        <canvas id="chart-minutes"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Messages per Hour</header>
                        <canvas id="chart-hours"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Messages per Day</header>
                        <canvas id="chart-days"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Frequency Shift (avg PPM per hour)</header>
                        <canvas id="chart-ppm"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Frequency Shift (avg PPM per minute)</header>
                        <canvas id="chart-ppm-minute"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Signal Level (Min/Max dB per minute)</header>
                        <canvas id="chart-level"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Distance (Max <span class="distunit">NMi</span> per Hour)</header>
                        <canvas id="chart-distance-hour"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Distance (Max <span class="distunit">NMi</span>  per Day)</header>
                        <canvas id="chart-distance-day"></canvas>
                    </div>
                    <br />
                    <div class="graph-panel">
                        <header>Max Distance Last Hour (<span class="distunit">NMi</span>)</header>
                        <canvas id="chart-radar-hour"></canvas>
                    </div>
                    <div class="graph-panel">
                        <header>Max Distance Last Day (<span class="distunit">NMi</span>)</header>
                        <canvas id="chart-radar-day"></canvas>
                    </div>
                </div>
            </div>

            <div class="tabcontent" id="ships">
                <div class="tablesection">
                    <table id="shipTable">
                        <thead>
                            <tr>
                                <th onclick="sortTable(this)" field="shipname">Shipname</th>
                                <th onclick="sortTable(this)" field="mmsi">MMSI</th>
                                <th onclick="sortTable(this)" field="callsign">Callsign</th>
                                <th onclick="sortTable(this)" field="last_signal">Last</th>
                                <th onclick="sortTable(this)" field="count">Msgs</th>
                                <th onclick="sortTable(this)" field="ppm">PPM</th>
                                <th onclick="sortTable(this)" field="level">RSSI</th>
                                <th onclick="sortTable(this)" field="distance">Dist</th>
                                <th onclick="sortTable(this)" field="bearing">Brg</th>
                                <th onclick="sortTable(this)" field="lat">Lat</th>
                                <th onclick="sortTable(this)" field="lon">Lon</th>
                                <th onclick="sortTable(this)" field="validated">Valid</th>
                                <th onclick="sortTable(this)" field="channels">Channels</th>
                            </tr>
                        </thead>
                        <tbody id="shipTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="tabcontent" id="map">
                <aside id="shipcard" class="shipcard-ismax">
                    <header id="shipcard_header">
                        <span onclick="toggleShipcardSize()" id="shipcard_header_title"></span>
                        <span><i title="Center map on current vessel" onclick="mapResetView(13)" class="shipcard-header-icon shipcard-min-only fa-solid fa-bullseye"></i></span>
                        <span><i title="Show track of current vessel" onclick="showTrack()" class="shipcard-header-icon  shipcard-min-only aside-toggle fa-solid fa-route "></i></span>
                        <span><i onclick="setStation()" class="shipcard-header-icon fa-solid  fa-thumbtack"></i></span>
                        <span><i onclick="toggleShipcardSize()" class="shipcard-header-icon shipcard-min-only fa-solid fa-plus"></i></span>
                        <span><i onclick="toggleShipcardSize()" class="shipcard-header-icon  shipcard-max-only fa-solid fa-minus"></i></span>
                        <span><i onclick="showShipcard(null)" style="color: red;" class="shipcard-header-icon fa-sharp fa-solid fa-xmark fa-lg"></i></span>
                    </header>

                    <div id="shipcard_content">
                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>Status</span><span id="shipcard_status"></span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>Sender</span><span id="shipcard_type"></span></div>
                            <div><span>Ship type</span><span id="shipcard_shiptype"></span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>MMSI</span><span id="shipcard_mmsi">-</span></div>
                            <div><span>Callsign</span><span id="shipcard_callsign">-</span></div>
                            <div><span>IMO</span><span id="shipcard_imo">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-row-selected">
                            <div><span>Course</span><span id="shipcard_cog">-</span></div>
                            <div><span>Speed</span><span id="shipcard_speed">-</span></div>
                            <div><span>Heading</span><span id="shipcard_heading">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only ">
                            <div><span>Latitude</span><span id="shipcard_lat">-</span></div>
                            <div><span>Longitude</span><span id="shipcard_lon">-</span></div>
                            <div><span>Distance</span><span id="shipcard_distance">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>Destination</span><span id="shipcard_destination"></span></div>
                            <div><span>ETA</span><span id="shipcard_eta"></span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>last signal</span><span id="shipcard_last_signal"></span></div>
                            <div><span>Count</span><span id="shipcard_count">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>RSSI</span><span id="shipcard_level">-</span></div>
                            <div><span>Drift</span><span id="shipcard_ppm">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>Dimension</span><span id="shipcard_dimension">-</span></div>
                            <div><span>Draught</span><span id="shipcard_draught">-</span></div>
                        </div>

                        <div onclick="shipcardselect(this)" class="shipcard-content-row shipcard-max-only">
                            <div><span>Msg type</span><span id="shipcard_msgtypes">-</span></div>
                            <div><span>Channels</span><span id="shipcard_channels">-</span></div>
                        </div>

                    </div>
                    <footer id="shipcard_footer" class="shipcard-footer shipcard-max-only">
                        <div title="Center map on current vessel" onclick="mapResetView(13)"><i class="fa-solid fa-bullseye fa-xl"></i><span>Focus</span></div>
                        <div title="Show track of current vessel" onclick="showTrack()"><i class="fa-solid fa-route fa-xl"></i><span>Track</span></div>
                    </footer>
                </aside>

                <div oncontextmenu="showContextMenu(event,0,['ctx-map'])" class="maptab">
                    <div id="leaflet_map"></div>
                </div>
            </div>

        </div>
    </div>
    <div class="bottombar"></div>

    <script>
        var chart_seconds, chart_minutes, interval, hist, ships, markers = {}, ship_shape = {}, map, basemaps = {}, overlapmaps = {}, station = {}, shipsDB = {}, singleClickTimeout = null;
        var iconLabelSpan = null, iconStationSpan = null;

        var StationControlDiv = null;
        var plugins = "", plugins_main = [];
        var card_mmsi = null, hover_mmsi = null, build_string = "unknown";
        var refreshIntervalMs = 2500;
        var range_update_time = null;

        var marker_center = null, marker_range = null, marker_station = null, marker_focus = null, marker_hover = null, marker_showtrack = false, marker_track = null;
        var shipCanvas;

        // default settings
        var settings = { map: 'Voyager', zoom: 10, lat: 0, lon: 0, fix_center: false, center_point: "station", dark_mode: false, center_radius: 0, metric: "DEFAULT", setcoord: true, sort: 'distance', sort_dir: 'asc', tab: 'stat', labels: false, eri: true, loadURL: true };
        let isFetchingShips = false;

        // some functions useful in plugins
        function addTileLayer(title, layer) { basemaps[title] = layer; }
        function removeTileLayer(title) { delete basemaps[title]; }
        function removeTileLayerAll() { basemaps = {}; }
        function addOverlayLayer(title, layer) { overlapmaps[title] = layer; }
        function removeOverlayLayer(title) { delete overlapmaps[title]; }
        function removeOverlayLayerAll() { overlapmaps = {}; }
        function addControlToMap(c) { c.addTo(map); }

        // transformations - for overwrite
        //getDimensionVal = c => Number(c).toFixed(0);
        //getDimensionUnit = c => "m";
        //getDistanceVal = c => Number(c).toFixed(1);
        //getDistanceUnit = c => "nmi";
        //getSpeedVal = c => Number(c).toFixed(1);
        //getSpeedUnit = c => "kts";
        getDimensionVal = c => settings.metric === "DEFAULT" ? Number(c).toFixed(0) : settings.metric === "SI" ? (Number(c).toFixed(0)) : (Number(c * 3.2808399).toFixed(0));
        getDimensionUnit = () => settings.metric === "DEFAULT" ? "m" : settings.metric === "SI" ? "m" : "ft";
        getDistanceConversion = c => settings.metric === "DEFAULT" ? c : settings.metric === "SI" ? (c * 1.852) : (c * 1.15078);
        getDistanceVal = c => Number(getDistanceConversion(c)).toFixed(1);
        getDistanceUnit = () => settings.metric === "DEFAULT" ? "nmi" : settings.metric === "SI" ? "km" : "mi";
        getSpeedVal = c => settings.metric === "DEFAULT" ? Number(c).toFixed(1) : settings.metric === "SI" ? (Number(c * 1.852).toFixed(1)) : (Number(c * 1.151).toFixed(1));
        getSpeedUnit = () => settings.metric === "DEFAULT" ? "kts" : settings.metric === "SI" ? "km/h" : "mph";

        getLatVal = ship => (ship.approx ? "<i>" : "") + Number(ship.lat).toFixed(5) + (ship.approx ? "</i>" : "");
        getLonVal = ship => (ship.approx ? "<i>" : "") + Number(ship.lon).toFixed(5) + (ship.approx ? "</i>" : "");
        getEtaVal = ship => (("0" + ship.eta_month).slice(-2)) + "-" + (("0" + ship.eta_day).slice(-2)) + " " + (("0" + ship.eta_hour).slice(-2)) + ":" + (("0" + ship.eta_minute).slice(-2));
        getDeltaTimeVal = s => s < 60 ? s + "s" : s < 60 * 60 ? Math.floor(s / 60) + "m " + (s % 60) + "s" : Math.floor(s / 3600) + "h " + Math.floor((s % 3600) / 60) + "m";
        getShipName = ship => ship.shipname;
        getCallSign = ship => ship.callsign;
        includeShip = ship => true;

</script>
<script>


        statpng = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAAUCAYAAADRA14pAAACXUlEQVRYhe3Ru47aQABG4UMWKSGJUJRqW9JlN+yKJim59duQBwD2kShyqXBtkheghJ4KF0gICewCISxRMgg7BYYYe2ZtME0uI42EMDr6Pwz/j/S8A1L/Su9+MGCmaXy5UPQeBjPQLtYbwEzjMvvuDAPTdXGFYKNpfE0YvQPDBNcFsQEtcc8A0wVXwEYj2b68YWC5Lu7+JkTnwbB22P1NhM4bYPliidAfglgJ+tkpvTA2hD6pF8RK0LF7SmwA/S1m9AnsETp2T4UNoGP1bqOwfnS7HRm9jcb60e3IXhTWj25HoG9k2NGIZb9PazhkokB/V0Rv5NjREvotGE4UaGVPhh3Bsg+tIUwUaGnvvQy73SIKBR6833xarRAStPDQV/6eHLsVUDj0YCUkaOGhj3oy7BZEAd8+EBK08NBX7OW1GtfZLC8k/6qby/Ha+/wmlcIN/iCdhkyGt8Dz/XcpateQlfYgd+hBKtSDNJA56n2G6yyKffj2IdkHZDjeB0C9TtU0sYNv0LKwez264zGL4DPHQeg6P4GX4S31Kph2+A1aNvS6MF6EnzkCdGmvDlUT7OAbtMDuQXcMi+AzB4SOah/QaFCRoWXXw/5QxnbFihwtu44A/cleAyoytOx62Ih9MdHxsKego7GnoGNj96fZpKxCe9hO7NiuWFajHQH6Sb0mlFVoD3vivh26FEQ7DutO54zYrlgKo501dM7qNaEURDuw7pyDPUR9aA+rA6/Oiu2Kpd9oZw2dRD0/2sMm3Ac8PlKcTpknxx6KRZjOk2IPNShOYX4RrO98vGTsD+j9PecXIj9PVcetObkAAAAASUVORK5CYII=";
        planepng = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAACt0lEQVRIx7XVT2hcVRTH8c9MJ5kwo5kEkv5Bilpr20j8E62xCyHZuHGhIM1CaXfWTUGoglpQF+rGZRE3BRVpEaSC1V2oGxcVsVhEIYZYK60UkyZmZpJmMs1k3nXhDQzTRidt8oPL475zzv3ec96959G6XkHYLl1FwKs2QD/t1zlf9uTkfp3z+Hm9Ae1YHNVfDobDGf0lVJFrJTjdImQ7Ou6Tq0F8ZnHPekKy0Ks9A1tlM2spQ3otzlnp8G9QyoZBblWtQB7Cx6vYTuCx29lAG97GEmof2TlZN1QNhkPdUPWE+yexHO3vRP81aQDnEZ7TWbxgcDIYDs3jd4N/HdA9Fy/n+Rh3g1I3uQ9v4nVkTto1PWJroV26Y7XdLEmqp0yWD5jojZm9j/dihjdA9uJTPPCCrrl37arukNvcauoXVa6+ZaLjM6VOjOEQvluBtEXyEaRO2VN81pZ8m1QOSdly+aJKeyKkd8qHgkxuzvLCbxbSaalkh9xSQaaAdE2ofGVqYcR4VzxUH+Ao/IpwUHfxkiemaoYq4x6f+cKe4vO6SrHeAeGcgcVgOJwzsNj4fkSh9Lnds2P2TtcMVa7YN/uSntlo/wXqL9s8dlrflaO2Xc1LrXTZ6/g2fqNHMNEEmcLDeC36LSLkpapv2DZzWt/lw3rHUYekYVcX8CGeQWdT2cdG9U8Hw+EbD87Eujfqzhh3LK6zsmaSiRftB5zBpQi9mUo1SQ9U1RNca7LP4+s4juBuPIXBDF5s8QCVm+Z//4dvgj9wHMfX1LtKlvNQUc9uVIMsBiEN1yXt8ae1rpAM7m16txs96wXZhE+w7w6ZGmyRXUAfRtHVygL/p2M49LT8nwfdJaFekNmUVb981rV+PIovUbvVdn+44bzXELqlluK82mA7eTvlamzdY/ixKLThe5yNADGbVfUPx0b/bFzy3uUAAAAASUVORK5CYII=";
        helicopterpng = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABkAAAAZCAYAAADE6YVjAAADxUlEQVRIx61VXWgcVRg9d+7Mnd3Zmd1N405oE5KakLbYgDTFH5BUEFo1WJuUNkiLEkVFxSb4UEVsUCutbWPAH1y10qAP2tJa6kMJltKU+CDqKmxQMNZV2ZikSkKSNTP7Mz97fcnCMuxuNq3n8Z7vO+fe7565A6wOr3wSDM5up/RL3AS2UuAogJoSXPiYovwV13V+OhRaAnBvGY37KPAmAFJYEDwFzW+r6r49ongRQJ2H69zq96sAsFGW6TrgwRIGe48oyqdPMdZVyeTcAcOIdvh8Db2S9BWAhgJRA2yIUBpcbvL3+nxtnt7HBwOBwWnHSX1oWT0A8uVMAOBEv2Gc2MyY9jRjlwC0AMB+xjYW10cobS/a7fNDgcDAhGWlopbVBeCnYkGhzFzfP2iabzSJotQny5cAtNWLYlNxwS2iuGb57l5+V1UP/pjLzZ6y7YcAJLxitEIIxkdte+ZhWd7VLgjddaJY3yhJSoHMcb54JZttf0vT9n6dzSbPOE4XgJlSQnSFtP0yats/389Y13ZVrSNFJw8IArmbMe28aV674Lq7AMyVExFWMFkPoHHOdVPEsyGREH8mn1cuuu73ABqL0+QFKeO8+5Dff6iVsfVNkiQHBUEpJ5DjPDdt2/nfLOvvkWz2s7F8fsBbI5ZqfEKStu3WtC3VfL0yIXIzY2hm7FZFELrHDKM6k89t+1pbOp3QKQ01SVIgUOEkNufmjOPwSdv+N5bLjVc9riJsALDvPVXt71CUcIlRzW2bnU3mgD4AMQD2jVy8uV8UOzmQOT4/H8sD2QJxfmkpNriw8PuQqq7VgZ0AnBt5LFselaTYUCCQBHAAwCNXa2sX47rO47rOd1IaBaB1Uno5qml/rAPeKTf+critj7GJo4ryK4Dewui+CIdTcV3nP0QiBoD+5XXfPYJw4aSmJbcQMlytUfsLspw4oihTAHqK1tWPNG0xrut8tLZ2EcCe4pDdQcjpU8HgP3cKwjkAcsX/yYs+X+J1v38SQKeXPKYo38V1nZ8Nh1MAWr1JvZ2Q4Y81bXIHpSOVnvqWaceZfzWTeQzAiNfkuutOAsC860oAkh7aGef8ycOGcSZMSH0VoSqNTYS8Ftf1/HFF+WY1fatym+B8Lsu5Ne26U6vpqyYJzwIgD1DasFkUO1zOxRpB2PQcYx9ELetPAD4AhysJkBUdGBvuDYW6ZUJC3nqHc/OKaV5/KZ1uvamTcCD/bSZjraHU0CmlEVGUFlzXnHddOmXbbppzEf8DegCMAVgLYMddgpAA8AyAZgADAE6uJPAfk1U+b+R6xyUAAAAASUVORK5CYII=";
        shippng = "data:image/png;base64,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";
  
        const markersCanvas = {
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // private: properties
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        _map: null,
        _canvas: null,
        _context: null,

        // leaflet markers (used to getBounds)
        _markers: [],

        // visible markers
        _markersTree: new RBush(),

        // every marker positions (even out of the canvas)
        _positionsTree: new RBush(),

        // icon images index
        _icons: {},

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // public: global
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        addTo(map) {
            map.addLayer(this);

            return this;
        },

        getBounds() {
            const bounds = new L.LatLngBounds();

            this._markers.forEach((marker) => {
            bounds.extend(marker.getLatLng());
            });

            return bounds;
        },

        redraw() {
            this._redraw(true);
        },

        clear() {
            this._positionsTree = new RBush();
            this._markersTree = new RBush();
            this._markers = [];
            this._redraw(true);
        },

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // public: markers
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        addMarker(marker) {
            const { markerBox, positionBox, isVisible } = this._addMarker(marker);

            if (markerBox && isVisible) {
            this._markersTree.insert(markerBox);
            }

            if (positionBox) {
            this._positionsTree.insert(positionBox);
            }
        },

        // add multiple markers (better for rBush performance)
        addMarkers(markers) {
            const markerBoxes = [];
            const positionBoxes = [];

            markers.forEach((marker) => {
            const { markerBox, positionBox, isVisible } = this._addMarker(marker);

            if (markerBox && isVisible) {
                markerBoxes.push(markerBox);
            }

            if (positionBox) {
                positionBoxes.push(positionBox);
            }
            });

            this._markersTree.load(markerBoxes);
            this._positionsTree.load(positionBoxes);
        },

        removeMarker(marker) {
            const latLng = marker.getLatLng();
            const isVisible = this._map.getBounds().contains(latLng);

            const positionBox = {
            minX: latLng.lng,
            minY: latLng.lat,
            maxX: latLng.lng,
            maxY: latLng.lat,
            marker,
            };

            this._positionsTree.remove(positionBox, (a, b) => {
            return a.marker._leaflet_id === b.marker._leaflet_id;
            });

            if (isVisible) {
            this._redraw(true);
            }
        },

        // remove multiple markers (better for rBush performance)
        removeMarkers(markers) {
            let hasChanged = false;

            markers.forEach((marker) => {
            const latLng = marker.getLatLng();
            const isVisible = this._map.getBounds().contains(latLng);

            const positionBox = {
                minX: latLng.lng,
                minY: latLng.lat,
                maxX: latLng.lng,
                maxY: latLng.lat,
                marker,
            };

            this._positionsTree.remove(positionBox, (a, b) => {
                return a.marker._leaflet_id === b.marker._leaflet_id;
            });

            if (isVisible) {
                hasChanged = true;
            }
            });

            if (hasChanged) {
            this._redraw(true);
            }
        },

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // leaflet: default methods
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        initialize(options) {
            L.Util.setOptions(this, options);
        },

        // called by Leaflet on `map.addLayer`
        onAdd(map) {
            this._map = map;
            this._initCanvas();
            this.getPane().appendChild(this._canvas);

            map.on("moveend", this._reset, this);
            map.on("resize", this._reset, this);

            map.on("click", this._fire, this);
            map.on("mousemove", this._fire, this);
            map.on("contextmenu", this._fire, this);

            if (map._zoomAnimated) {
            map.on("zoomanim", this._animateZoom, this);
            }
        },

        // called by Leaflet
        onRemove(map) {
            this.getPane().removeChild(this._canvas);

            map.off("click", this._fire, this);
            map.off("mousemove", this._fire, this);
            map.off("contextmenu", this._fire, this);
            map.off("moveend", this._reset, this);
            map.off("resize", this._reset, this);

            if (map._zoomAnimated) {
            map.off("zoomanim", this._animateZoom, this);
            }
        },

        setOptions(options) {
            L.Util.setOptions(this, options);

            return this.redraw();
        },

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // private: global methods
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        _initCanvas() {
            const { x, y } = this._map.getSize();
            const isAnimated = this._map.options.zoomAnimation && L.Browser.any3d;

            this._canvas = L.DomUtil.create(
            "canvas",
            "leaflet-markers-canvas-layer leaflet-layer"
            );
            this._canvas.width = x;
            this._canvas.height = y;
            this._context = this._canvas.getContext("2d");

            L.DomUtil.addClass(
            this._canvas,
            `leaflet-zoom-${isAnimated ? "animated" : "hide"}`
            );
        },

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // private: marker methods
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        _addMarker(marker) {
            if (marker.options.pane !== "markerPane" || !marker.options.icon) {
            console.error("This is not a marker", marker);

            return { markerBox: null, positionBox: null, isVisible: null };
            }

            // required for pop-up and tooltip
            marker._map = this._map;

            // add _leaflet_id property
            L.Util.stamp(marker);

            const latLng = marker.getLatLng();
            const isVisible = this._map.getBounds().contains(latLng);
            const { x, y } = this._map.latLngToContainerPoint(latLng);
            const { iconSize, iconAnchor } = marker.options.icon.options;

            const markerBox = {
            minX: x - iconAnchor[0],
            minY: y - iconAnchor[1],
            maxX: x + iconSize[0] - iconAnchor[0],
            maxY: y + iconSize[1] - iconAnchor[1],
            marker,
            };

            const positionBox = {
            minX: latLng.lng,
            minY: latLng.lat,
            maxX: latLng.lng,
            maxY: latLng.lat,
            marker,
            };

            if (isVisible) {
            this._drawMarker(marker, { x, y });
            }

            this._markers.push(marker);

            return { markerBox, positionBox, isVisible };
        },

        _drawMarker(marker, { x, y }) {
            const { iconUrl } = marker.options.icon.options;

            if (marker.image) {
            this._drawImage(marker, { x, y });
            } else if (this._icons[iconUrl]) {
            marker.image = this._icons[iconUrl].image;

            if (this._icons[iconUrl].isLoaded) {
                this._drawImage(marker, { x, y });
            } else {
                this._icons[iconUrl].elements.push({ marker, x, y });
            }
            } else {
            const image = new Image();
            image.src = iconUrl;
            marker.image = image;

            this._icons[iconUrl] = {
                image,
                isLoaded: false,
                elements: [{ marker, x, y }],
            };

            image.onload = () => {
                this._icons[iconUrl].isLoaded = true;
                this._icons[iconUrl].elements.forEach(({ marker, x, y }) => {
                this._drawImage(marker, { x, y });
                });
            };
            }
        },

        _drawImage(marker, { x, y }) {
            const { rotationAngle, iconAnchor, iconSize, iconOffset } = marker.options.icon.options;
            const angle = rotationAngle || 0;
            const sx = iconOffset ? iconOffset[0] : 0;
            const sy = iconOffset ? iconOffset[1] : 0;

            this._context.save();
            this._context.translate(x, y);
            this._context.rotate((angle * Math.PI) / 180);
            this._context.drawImage(marker.image,sx,sy,iconSize[0],iconSize[1],-iconAnchor[0],-iconAnchor[1],iconSize[0],iconSize[1]);
            this._context.restore();
        },

        _redraw(clear) {
            if (clear) {
            this._context.clearRect(0, 0, this._canvas.width, this._canvas.height);
            }

            if (!this._map || !this._positionsTree) return;

            const mapBounds = this._map.getBounds();
            const mapBoundsBox = {
                minX: mapBounds.getWest(),
                minY: mapBounds.getSouth(),
                maxX: mapBounds.getEast(),
                maxY: mapBounds.getNorth(),
            };

            // draw only visible markers
            const markers = [];
            this._positionsTree.search(mapBoundsBox).forEach(({ marker }) => {
            const latLng = marker.getLatLng();
            const { x, y } = this._map.latLngToContainerPoint(latLng);
            const { iconSize, iconAnchor } = marker.options.icon.options;

            const markerBox = {
                minX: x - iconAnchor[0],
                minY: y - iconAnchor[1],
                maxX: x + iconSize[0] - iconAnchor[0],
                maxY: y + iconSize[1] - iconAnchor[1],
                marker,
            };

            markers.push(markerBox);
            this._drawMarker(marker, { x, y });
            });

            this._markersTree.clear();
            this._markersTree.load(markers);
        },

        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *
        //
        // private: event methods
        //
        // * * * * * * * * * * * * * * * * * * * * * * * * * * * *

        _reset() {
            const topLeft = this._map.containerPointToLayerPoint([0, 0]);
            L.DomUtil.setPosition(this._canvas, topLeft);

            const { x, y } = this._map.getSize();
            this._canvas.width = x;
            this._canvas.height = y;

            this._redraw();
        },

        _fire(event) {
            if (!this._markersTree) return;

            const { x, y } = event.containerPoint;
            const markers = this._markersTree.search({
            minX: x,
            minY: y,
            maxX: x,
            maxY: y,
            });

            if (markers && markers.length) {
            this._map._container.style.cursor = "pointer";
            const marker = markers[0].marker;

            if (event.type === "click") {
                if (marker.listens("click")) {
                    // remove click from propagation and being picked up by map.on('click') listeners
                    L.DomEvent.stopPropagation(event);
                    event.originalEvent.stopPropagation();

                marker.fire("click");
                }
            }

            if (event.type === "contextmenu") {
                if (marker.listens("contextmenu")) {
                marker.fire("contextmenu");
                }
            }
            if (event.type === "mousemove") {
                if (this._mouseOverMarker && this._mouseOverMarker !== marker) {
                if (this._mouseOverMarker.listens("mouseout")) {
                    this._mouseOverMarker.fire("mouseout");
                }
                }

                if (!this._mouseOverMarker || this._mouseOverMarker !== marker) {
                this._mouseOverMarker = marker;
                if (marker.listens("mouseover")) {
                    marker.fire("mouseover");
                }
                }
            }
            } else {
            this._map._container.style.cursor = "";
            if (event.type === "mousemove" && this._mouseOverMarker) {
                if (this._mouseOverMarker.listens("mouseout")) {
                this._mouseOverMarker.fire("mouseout");
                }

                delete this._mouseOverMarker;
            }
            }
        },

        _animateZoom(event) {
            const scale = this._map.getZoomScale(event.zoom);
            const offset = this._map._latLngBoundsToNewLayerBounds(
            this._map.getBounds(),
            event.zoom,
            event.center
            ).min;

            L.DomUtil.setTransform(this._canvas, offset, scale);
        },
        };

        L.MarkersCanvas = L.Layer.extend(markersCanvas);
        

        // https://stackoverflow.com/questions/51805395/navigator-clipboard-is-undefined
        async function copyClipboard(t) {
            try {
                await copyToClipboard(t);
            } catch(error) {
                showDialog("Action","No privilege for program to copy to the clipboard. Please select and copy (CTRL-C) the following string manually: " + t);
            }
        }

        async function copyToClipboard(textToCopy) {
            // Navigator clipboard api needs a secure context (https)
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(textToCopy);
            } else {
                // Use the 'out of viewport hidden text area' trick
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                    
                // Move textarea out of the viewport so it's not visible
                textArea.style.position = "absolute";
                textArea.style.left = "-999999px";
                    
                document.body.prepend(textArea);
                textArea.select();

                try {
                    document.execCommand('copy');
                } catch (error) {
                    console.error(error);
                } finally {
                    textArea.remove();
                }
            }
        }
        
        function copyCoordinates(m) {
            let coords = 'not found';

            if (m in shipsDB)
                coords = shipsDB[m].raw.lat + "," + shipsDB[m].raw.lon;
            copyClipboard(coords);
        }

        async function fetchNMEA(m) {
            try {
                response = await fetch('message?'+m);
            } catch (error) {
                return "Error fetching message from server.";
            }
            return response.text();
        }

        async function showNMEA(m) {

            if (typeof message_save !== 'undefined' && message_save) {
                    s = await fetchNMEA(m);
                    showDialog("Message " + m,s+"\n");
            }
            else 
                showDialog("Error","Please enable 'MESSAGE on' on AIS-catcher settings.");
        }

        function copyMMSI(m) {
            copyClipboard(m);
        }

        function openGoogleSearch(m) {
            window.open("https://www.google.com/search?q=" + m);
        }

        function openMarineTraffic(m) {
            window.open(" https://www.marinetraffic.com/en/ais/details/ships/mmsi:" + m);
        }

        function openShipXplorer(m) {
            window.open("https://www.shipxplorer.com/data/vessels/IMO-MMSI-" + m);
        }

        function openVesselFinder(m) {
            window.open("https://www.vesselfinder.com/vessels/details/" + m);
        }

        function showContextMenu(event, mmsi, context) {
            var contextMenu = document.getElementById('context-menu');

            event.preventDefault();
            event.stopPropagation();

            context_mmsi = mmsi;

            b = context.includes("mmsi-map");
            mmsiItems = document.querySelectorAll('.mmsi-map');
            mmsiItems.forEach(item => {
                item.style.display = b ? 'flex' : 'none';
            });
            b = context.includes("mmsi");
            mmsiItems = document.querySelectorAll('.mmsi');
            mmsiItems.forEach(item => {
                item.style.display = b ? 'flex' : 'none';
            });
            b = context.includes("ctx-map");
            mmsiItems = document.querySelectorAll('.ctx-map');
            mmsiItems.forEach(item => {
                item.style.display = b ? 'flex' : 'none';
            });

            contextMenu.style.display = 'block';
            contextMenu.style.left = (event.pageX + 5) + 'px';
            contextMenu.style.top = (event.pageY + 5) + 'px';

            var contextMenuRect = contextMenu.getBoundingClientRect();
            var viewportWidth = window.innerWidth || document.documentElement.clientWidth;
            var viewportHeight = window.innerHeight || document.documentElement.clientHeight;

            var maxX = viewportWidth - contextMenuRect.width;
            var maxY = viewportHeight - contextMenuRect.height;

            var adjustedX = Math.min(event.pageX + 5, maxX);
            var adjustedY = Math.min(event.pageY + 5, maxY);

            contextMenu.style.left = adjustedX + 'px';
            contextMenu.style.top = adjustedY + 'px';

            document.addEventListener('click', function hideContextMenu(event) {
                contextMenu.style.display = 'none';
                document.removeEventListener('click', hideContextMenu);
            });
        }

        function showDialog(title, message) {
            var dialogBox = document.getElementById('dialog-box');
            var dialogTitle = dialogBox.querySelector('.dialog-title');
            var dialogMessage = dialogBox.querySelector('.dialog-message');
            
            dialogTitle.innerText = title;
            dialogMessage.innerText = message;
            dialogBox.classList.remove('hidden');
        }

        function closeDialog() {
            var dialogBox = document.getElementById('dialog-box');
            dialogBox.classList.add('hidden');
        }

        function getStatusVal(ship) {
            const StringFromStatus = ["Under way using engine",
                "At anchor",
                "Not under command",
                "Restricted manoeuverability",
                "Constrained",
                "Moored",
                "Aground",
                "Engaged in Fishing",
                "Under way sailing",
                "Reserved for HSC",
                "Reserved for WIG",
                "Reserved",
                "Reserved",
                "Reserved",
                "AIS-SART is active",
                "Not available"
            ];

            return StringFromStatus[Math.min(ship.status, 15)];
        }

        function getShipTypeVal(s) {
            if (s < 20) return "Not available";
            if (s <= 29) return "WIG";
            if (s <= 30) return "Fishing";
            if (s <= 32) return "Towing";
            if (s <= 34) return "Dredging/Diving ops";
            if (s <= 35) return "Military";
            if (s <= 36) return "Sailing";
            if (s <= 37) return "Pleasure Craft";
            if (s <= 39) return "Reserved";
            if (s <= 49) return "High Speed Craft";
            if (s <= 50) return "Pilot";
            if (s <= 51) return "Search And Rescue";
            if (s <= 52) return "Tug";
            if (s <= 53) return "Port tender";
            if (s <= 54) return "Anti-pollution equipment";
            if (s <= 55) return "Law Enforcement";
            if (s <= 57) return "Local Vessel";
            if (s <= 58) return "Medical Transport";
            if (s <= 59) return "Noncombatant ship";
            if (s <= 69) return "Passenger";
            if (s <= 79) return "Cargo";
            if (s <= 89) return "Tanker";
            if (s <= 99) return "Other";

            if ((settings.eri == true || settings.eri === "true") && ((s >= 1500 && s <= 1920) || (s >= 8000 && s <= 8510))) {
                switch (s) {
                    case 8000: return "Unknown (inland AIS)";
                    case 8010: return "Motor Freighter";
                    case 8020: return "Motor Tanker";
                    case 8021: return "Motor Tanker (liquid)";
                    case 8022: return "Motor Tanker (liquid)";
                    case 8023: return "Motor Tanker (dry)";
                    case 8030: return "Container";
                    case 8040: return "Gas Tanker";
                    case 8050: return "Motor Freighter (tug)";
                    case 8060: return "Motor Tanker (tug)";
                    case 8070: return "Motor Freighter (alongside)";
                    case 8080: return "Motor Freighter (with tanker)";
                    case 8090: return "Motor Freighter (pushing)";
                    case 8100: return "Motor Freighter (pushing)";
                    case 8110: return "Tug, Freighter";
                    case 8120: return "Tug, Tanker";
                    case 8130: return "Tug Freighter (coupled)";
                    case 8140: return "Tug, freighter/tanker";
                    case 8150: return "Freightbarge";
                    case 8160: return "Tankbarge";
                    case 8161: return "Tankbarge (liquid)";
                    case 8162: return "Tankbarge (liquid)";
                    case 8163: return "Tankbarge (dry)";
                    case 8170: return "Freightbarge (with containers)";
                    case 8180: return "Tankbarge (gas)";
                    case 8210: return "Pushtow (one cargo barge)";
                    case 8220: return "Pushtow (two cargo barges)";
                    case 8230: return "Pushtow, (three cargo barges)";
                    case 8240: return "Pushtow (four cargo barges)";
                    case 8250: return "Pushtow (five cargo barges)";
                    case 8260: return "Pushtow (six cargo barges)";
                    case 8270: return "Pushtow (seven cargo barges)";
                    case 8280: return "Pushtow (eigth cargo barges)";
                    case 8290: return "Pushtow (nine or more barges)";
                    case 8310: return "Pushtow (one tank/gas barge)";
                    case 8320: return "Pushtow (two barges)";
                    case 8330: return "Pushtow (three barges)";
                    case 8340: return "Pushtow (four barges)";
                    case 8350: return "Pushtow (five barges)";
                    case 8360: return "Pushtow (six barges)";
                    case 8370: return "Pushtow (seven barges)";
                    case 8380: return "Pushtow (eight barges)";
                    case 8390: return "Pushtow (nine or more barges)";
                    case 8400: return "Tug (single)";
                    case 8410: return "Tug (one or more tows)";
                    case 8420: return "Tug (assisting)";
                    case 8430: return "Pushboat (single)";
                    case 8440: return "Passenger";
                    case 8441: return "Ferry";
                    case 8442: return "Red Cross";
                    case 8443: return "Cruise";
                    case 8444: return "Passenger";
                    case 8450: return "Service, Police or Port Service";
                    case 8460: return "Maintainance Craft";
                    case 8470: return "Object (towed)";
                    case 8480: return "Fishing";
                    case 8490: return "Bunkership";
                    case 8500: return "Barge, Tanker, Chemical";
                    case 8510: return "Object";
                    case 1500: return "General";
                    case 1510: return "Unit Carrier Maritime";
                    case 1520: return "bulk Carrier Maritime";
                    case 1530: return "Tanker";
                    case 1540: return "Liquified Gas Tanker";
                    case 1850: return "Pleasure";
                    case 1900: return "Fast Ship";
                    case 1910: return "Hydrofoil";
                    case 1920: return "Catamaran Fast";
                }
            }
            return "Unknown (" + s + ")";
        }

        const ShippingClass = {
            CARGO: 0,
            B: 1,
            PASSENGER: 2,
            SPECIAL: 3,
            TANKER: 4,
            HIGHSPEED: 5,
            PLANE: 6,
            HELICOPTER: 7,
            STATION: 8,
            ATON: 9,
            SARTEPIRB: 10,
            FISHING: 12,
            OTHER: 13
        };

        // MMSI types from AIS-catcher
        const OTHER = 0;
        const CLASS_A = 1;
        const CLASS_B = 2;
        const BASESTATION = 3;
        const SAR = 4;
        const SARTEPIRB = 5;
        const ATON = 6;

        const CLASS_A_MASK = 1 << 1 | 1 << 2 | 1 << 3 | 1 << 5;
        const CLASS_B_MASK = 1 << 18 | 1 << 19 | 1 << 24;
        const BASESTATION_MASK = 1 << 4 | 1 << 16 | 1 << 17 | 1 << 20 | 1 << 22 | 1 << 23;
        const SAR_MASK = 1 << 9;
        const ATON_MASK = 1 << 21;

        function getMMSItype(ship) {

            if ((ship.mmsi > 111000000 && ship.mmsi < 111999999) ||
                (ship.mmsi > 11100000 && ship.mmsi < 11199999))
                return SAR;

            if (ship.msg_type & BASESTATION_MASK) return BASESTATION;
            if (ship.msg_type & SAR_MASK) return SAR;
            if (ship.msg_type & ATON_MASK) return ATON;

            if (ship.mmsi >= 97000000 && ship.mmsi <= 98000000)
                return SARTEPIRB;

            if (ship.msg_type & CLASS_A_MASK) return CLASS_A;
            if (ship.msg_type & CLASS_B_MASK) return CLASS_B;

            return OTHER;
        }

        function getShipTypeClassEri(ship) {
            switch (ship.shiptype) {
                case 8030:
                case 8010:
                case 8070:
                case 8210:
                case 8220:
                case 8230:
                case 8240:
                case 8250:
                case 8260:
                case 8270:
                case 8280:
                case 8290:
                case 8310:
                case 8320:
                case 8330:
                case 8340:
                case 8350:
                case 8360:
                case 8370:
                case 8380:
                case 8390:
                case 8130:
                case 8140:
                case 8150:
                case 8170:
                case 8410: return ShippingClass.CARGO;
                case 8020:
                case 8021:
                case 8022:
                case 8023:
                case 8040:
                case 8060:
                case 8160:
                case 8161:
                case 8162:
                case 8163:
                case 8180:
                case 8490:
                case 8500:
                case 1530:
                case 1540: return ShippingClass.TANKER;
                case 8050:
                case 8080:
                case 8090:
                case 8100:
                case 8110:
                case 8120:
                case 8400:
                case 8420:
                case 8430:
                case 8450:
                case 8460:
                case 8470:
                case 8510: return ShippingClass.SPECIAL;
                case 8440:
                case 8441:
                case 8442:
                case 8443:
                case 8444: return ShippingClass.PASSENGER;
                case 8480: return ShippingClass.FISHING;
                case 1850: return ShippingClass.B;
                case 1900:
                case 1910:
                case 1920: return ShippingClass.HIGHSPEED;
            }
            return ShippingClass.OTHER;
        }

        function getShipTypeClass(ship) {

            let c = ShippingClass.UNKNOWN;

            switch (ship.mmsi_type) {
                case CLASS_A:
                case CLASS_B:
                    if (ship.mmsi_type == CLASS_B)
                        c = ShippingClass.B;
                    else
                        c = ShippingClass.UNKNOWN;

                    // overwrite default if we have a better mapping
                    if (ship.shiptype >= 80 && ship.shiptype < 90) c = ShippingClass.TANKER;
                    else if (ship.shiptype >= 70 && ship.shiptype < 80) c = ShippingClass.CARGO;
                    else if (ship.shiptype >= 60 && ship.shiptype < 70) c = ShippingClass.PASSENGER
                    else if (ship.shiptype >= 40 && ship.shiptype < 50) c = ShippingClass.HIGHSPEED;
                    else if (ship.shiptype >= 50 && ship.shiptype < 60) c = ShippingClass.SPECIAL;
                    else if (ship.shiptype == 30) c = ShippingClass.FISHING;
                    else if ((settings.eri == true || settings.eri === "true") && ((ship.shiptype >= 1500 && ship.shiptype <= 1920) || (ship.shiptype >= 8000 && ship.shiptype <= 8510)))
                        c = getShipTypeClassEri(ship);
                    break;
                case BASESTATION:
                    c = ShippingClass.STATION;
                    break;
                case SAR:
                    c = ShippingClass.HELICOPTER;
                    if (ship.mmsi > 111000000 && ship.mmsi < 111999999) {
                        if (Math.floor((ship.mmsi / 100) % 10, 0) == 1) c = ShippingClass.PLANE;
                    }
                    else if (ship.mmsi > 11100000 && ship.mmsi < 11199999)
                        if (Math.floor((ship.mmsi / 10) % 10, 0) == 1) c = ShippingClass.PLANE;
                    break;
                case SARTEPIRB:
                    c = ShippingClass.SARTEPIRB;
                    break;
                case ATON:
                    c = ShippingClass.ATON;
                    break;
            }

            return c;
        }


        function headerClick() {
            window.open('https://github.com/jvde-github/AIS-catcher');
        }

        function initMap() {

            map = L.map('map', { zoomControl: false, zoomSnap: 0.01 }).setView([settings.lat, settings.lon], settings.zoom);
            var control = L.control.layers(basemaps, overlapmaps, { title: 'Select map and overlays', position: 'bottomright' }).addTo(map);
            map.on('baselayerchange', function (event) { settings.map = event.name; saveSettings(); });
            map.on('mousemove', function (evt) { saveSettings(); updateTooltips(); });
            map.on('zoomend', function (evt) { saveSettings(); updateTooltips(); });
            /*
            map.on('click', function () {
                if (singleClickTimeout == null) {
                    singleClickTimeout = setTimeout(() => { showShipcard(null); hideMenuifSmall(); singleClickTimeout = null; }, 400);
                }
            });
            */
            map.on('dblclick dragstart zoomstart', function () { if (singleClickTimeout != null) { clearTimeout(singleClickTimeout); singleClickTimeout = null; } });

            map.addControl(new L.Control.Zoom({ position: 'bottomright' }));
            L.control.scale().addTo(map);

            ((settings.map in basemaps) ? basemaps[settings.map] : basemaps[Object.keys(basemaps)[0]]).addTo(map);

            map.createPane("locationMarker");
            map.getPane("locationMarker").style.zIndex = 999;

            L.DomEvent.disableClickPropagation(document.getElementById('shipcard'));

            shipCanvas = new L.MarkersCanvas();
            shipCanvas.addTo(map);
        }

        function updateLabelControl() {
            iconLabelSpan.classList.remove('blue');
            iconLabelSpan.classList.remove('red');
            iconLabelSpan.classList.remove('grey');

            if (settings.labels) {
                iconLabelSpan.classList.add('blue');
            }
            else {
                iconLabelSpan.classList.add('grey');
            }
        }

        function updateStationControl(center) {
            iconStationSpan.classList.remove('blue');
            iconStationSpan.classList.remove('red');
            iconStationSpan.classList.remove('grey');

            if (!center.hasOwnProperty('lat') || !center.hasOwnProperty('lon')) {
                iconStationSpan.classList.add('red');
                map.dragging.enable();
            }
            else if (settings.fix_center) {
                iconStationSpan.classList.add('blue');
                map.dragging.disable();
            }
            else {
                iconStationSpan.classList.add('grey');
                map.dragging.enable();
            }
        }

        function addLabelControl() {
            // ------------
            var labelToggleControl = L.control({ position: 'bottomright' });

            labelToggleControl.onAdd = function (map) {

                var controlDiv = L.DomUtil.create('div', 'leaflet-control-layers');
                controlDiv.title = "Show labels on screen";
                var controlBoundary = L.DomUtil.create('div', 'leaflet-control-label-toggle', controlDiv);
                iconLabelSpan = L.DomUtil.create('span', 'fas fa-tag', controlBoundary);
                updateLabelControl();

                controlDiv.addEventListener('click', function () {

                    settings.labels = !settings.labels;
                    updateLabelControl();
                    saveSettings();

                    if (!settings.labels) {
                        for (let [key, m] of Object.entries(markers))
                            if (m.isTooltipOpen()) m.getTooltip().toggle();
                    }
                    else
                        updateTooltips();
                });
                return controlDiv;
            };
            addControlToMap(labelToggleControl);
        }


        function addRangeControl() {
            // ------------
            var rangeToggleControl = L.control({ position: 'bottomright' });

            rangeToggleControl.onAdd = function (map) {

                var controlDiv = L.DomUtil.create('div', 'leaflet-control-layers');
                controlDiv.title = "Show range";
                var controlBoundary = L.DomUtil.create('div', 'leaflet-control-label-toggle', controlDiv);
                iconRangeSpan = L.DomUtil.create('span', 'fas fa-tower-cell', controlBoundary);
                updateRangeControl();

                controlDiv.addEventListener('click', function () {

                    if (!settings.show_range) {
                        if (!((typeof param_share_loc != "undefined") && param_share_loc) || typeof param_lat === "undefined" || typeof param_lon === "undefined") {
                            alert("Warning: Unable to show range as AIS-catcher was not started with 'share_loc on lat xxx lon yyy'");
                        }
                    }

                    settings.show_range = !settings.show_range;
                    updateRangeControl();
                    saveSettings();

                    if (!settings.show_range) {
                        if (marker_range != null) {
                            map.removeLayer(marker_range);
                            marker_range = null;
                        }
                    }
                    else
                        plotRange();
                });
                return controlDiv;
            };
            addControlToMap(rangeToggleControl);
        }

        function addStationControl() {
            // ------------
            var stationToggleControl = L.control({ position: 'bottomright' });

            stationToggleControl.onAdd = function (map) {

                StationControlDiv = L.DomUtil.create('div', 'leaflet-control-layers');
                StationControlDiv.title = "Fix map center at center point";
                var controlBoundary = L.DomUtil.create('div', 'leaflet-control-station-toggle', StationControlDiv);
                iconStationSpan = L.DomUtil.create('span', 'fas fa-bullseye', controlBoundary);
                updateStationControl({});

                StationControlDiv.addEventListener('click', function () {

                    settings.fix_center = !settings.fix_center;
                    saveSettings();
                    plotStation();
                });
                return StationControlDiv;
            };
            addControlToMap(stationToggleControl);
        }



        function showPlugins() {
            showDialog("Plugins","Loaded plugins:\n" + plugins);
        }

        async function fetchStatistics() {
            try {
                response = await fetch('stat.json');
            } catch (error) {
                setPulseError();
                return;
            }
            statistics = await response.json();
            setPulseOk();
            return statistics;
        }

        async function fetchAbout() {
            try {
                response = await fetch('about.md');
            } catch (error) {
                return;
            }
            aboutmd = await response.text();
            return aboutmd;
        }

        async function plotRange() {

            const nothasStation = station == null || !station.hasOwnProperty("lat") || !station.hasOwnProperty("lon");

            if (nothasStation || !settings.show_range) return;

            // range plotted in last 15 minutes then return
            if (marker_range != null) {
                if (range_update_time != null) {

                    const now = new Date();

                    if (Math.floor((now - range_update_time) / 1000 / 60) < 15) return;
                    range_update_time = now;
                }
                else
                    range_update_time = new Date();

                map.removeLayer(marker_range);
                marker_range = null;
            }

            // get range data
            if (true) {
                try {
                    response = await fetch('history_full.json');
                } catch (error) {
                    setPulseError();
                }
                h = await response.json();
                setPulseOk();
            }
            else {
                h = JSON.parse(range_json);
            }

            // calculate range
            const range_outline = [];

            const N = h.day.stat[0].radar_a.length;
            range = [];

            for (let i = 0; i < N; i++) {
                let m = 0;
                for (j = 0; j < h.hour.stat.length; j++) {
                    m = Math.max(m, h.hour.stat[j].radar_a[i]);
                    m = Math.max(m, h.hour.stat[j].radar_b[i]);
                }
                for (j = 0; j < h.minute.stat.length; j++) {
                    m = Math.max(m, h.minute.stat[j].radar_a[i]);
                    m = Math.max(m, h.minute.stat[j].radar_b[i]);
                }
                range.push(m);
            }

            const deltaNorth = calcOffset1M(station, 0);
            const deltaEast = calcOffset1M(station, 90);

            for (let i = 0; i < N; i++) {
                range_outline.push({
                    lat: station.lat + range[i] * deltaNorth[0] * 1000 / 0.5399568 * Math.cos(i * 2 / N * Math.PI),
                    lon: station.lon + range[i] * deltaEast[1] * 1000 / 0.5399568 * Math.sin(i * 2 / N * Math.PI)
                });

                range_outline.push({
                    lat: station.lat + range[i] * deltaNorth[0] * 1000 / 0.5399568 * Math.cos((i + 1) * 2 / N * Math.PI),
                    lon: station.lon + range[i] * deltaEast[1] * 1000 / 0.5399568 * Math.sin((i + 1) * 2 / N * Math.PI)
                });

            }

            marker_range = L.polygon(range_outline, { fillOpacity: 0.05, color: 'orange' });
            marker_range.addTo(map);
        }

        async function fetchShips(noDoubleFetch = true) {
            if (isFetchingShips && noDoubleFetch) {
                console.log("A fetch operation is already running.");
                return;
            }

            let ships = {};
            station = {};

            if (true) {
                isFetchingShips = true;
                try {
                    response = await fetch('ships_array.json');
                } catch (error) {
                    setPulseError();
                    console.log("failed loading ships: " + error);
                    return;
                }
                finally {
                    isFetchingShips = false;
                }
                ships = await response.json();
            }
            else {
                ships_json = '{"count":359,"station":{"lat":52.081657,"lon":4.338417},"values":[[255806165,51.978302,4.078057,11.445821,237,-78.448105,270,0.578704,false,307,309.800018,12.900001,125,10,10,14,71,1,42,3,"PT",5,8.300000,5,2,22,0,9326964,"CQAG3","WEC FRANS HALS","BEANR",1],[257630000,52.195030,4.257333,7.433959,336,-77.056473,1716,1.736111,false,282,293.600006,1.500000,190,55,16,28,80,1,42,3,"NO",0,8.600000,4,27,8,0,9863558,"LAKU8","ALTERA WAVE","NL SCE",2],[219110000,51.958717,4.052983,12.872696,235,-73.024437,774,4.629630,false,83,173.100006,0.000000,161,39,18,18,71,1,16777258,3,"DK",0,9.400001,5,3,15,0,9775751,"OWCF2","VAYENGA MAERSK","NLRTM>DEBRV",3],[2442006,null,null,null,null,-76.017876,18625,2.893518,false,null,null,null,null,null,null,null,0,0,16,3,"NL",15,0.000000,null,null,null,null,null,"","","",3],[352002025,51.914635,4.244802,10.608397,199,-79.239510,108,2.314815,false,302,302.000000,7.500000,128,28,9,16,80,1,42,3,"PA",0,6.600000,5,1,16,0,9952153,"3E2190","BOW PANTHER","NLRTM",3],[245562000,52.161732,4.330645,4.816397,356,-82.195641,176,-1.157407,false,216,236.300003,3.100000,null,null,null,null,0,1,10,3,"NL",5,0.000000,null,null,null,null,null,"","","",3],[249525000,51.959301,4.052967,12.853073,235,-80.582085,1479,2.025463,false,249,251.000000,6.300000,12,16,5,5,52,1,42,3,"MT",0,4.500000,7,4,20,0,9402421,"9HB4828","VB HUDSON","ROTTERDAM",3],[538007953,51.962383,4.130816,10.493444,227,-77.650757,281,1.446759,false,312,310.300018,4.700000,213,37,28,16,80,1,42,3,"MH",0,8.600000,5,2,14,0,9728435,"V7BT5","IONIC ALTHEA","NLRTM",4],[244770939,52.190929,4.136197,9.928713,311,-77.195480,6291,1.736111,false,null,null,null,null,null,null,null,0,1,4112,3,"NL",15,0.000000,null,null,null,null,null,"","","",8],[244620975,52.064697,4.343582,1.035932,169,-70.706017,228,-0.578704,false,null,180.000000,0.100000,60,10,5,3,8010,1,298,3,"NL",0,3.000000,4,27,11,49,2325435,"PD3543","COTRANS 11","BORN",10],[257165000,52.099346,4.266161,2.869318,291,-74.386192,519,4.050926,false,43,213.699997,0.000000,55,9,4,5,36,1,40,3,"NO",5,4.500000,4,29,10,0,5334561,"LDTY","SORLANDET","SCHEVENINGEN",10],[566017000,52.194286,4.203895,8.384701,323,-77.116653,322,1.736111,false,287,220.900009,0.000000,96,17,15,4,82,1,40,3,"SG",1,5.200000,3,11,2,0,9743253,"9V2945","EPIC BONAIRE","NLRTM",11],[244620984,52.058365,4.345452,1.422297,169,-78.663101,1170,-1.157407,false,null,142.900009,5.500000,50,13,3,4,8010,1,298,3,"NL",0,0.000000,9,20,5,0,3250303,"PG5169","CHAPERON","GOTTERWICKERSHAM",12],[244719315,52.074055,4.317698,0.890404,239,-58.407764,706,-1.157407,false,null,null,0.000000,20,4,4,1,8000,1,16777512,3,"NL",5,0.000000,null,null,0,0,null,"PG6249","ST.RAFAEL","",14],[247373700,51.923248,4.197093,10.851041,208,-81.533081,39,3.761574,false,53,226.900009,1.000000,90,23,7,11,81,1,42,3,"IT",0,7.000000,5,2,10,0,9321433,"IBPM","MARY  A","NLRTM",15],[244710825,52.099335,4.270236,2.729997,292,-81.385292,2305,-0.868056,false,null,0.000000,0.000000,3,7,2,2,30,1,42,3,"NL",7,0.000000,null,null,null,null,null,"PD4198","SCH 335 MANDY","",20],[244974000,52.101585,4.266992,2.893810,294,-81.673012,2444,2.025463,false,241,280.899994,0.000000,12,6,2,3,51,1,42,3,"NL",0,1.000000,4,28,15,0,null,"PBMA","KITTY ROOSMALE NEP.","SCHEVENINGEN",21],[246189000,52.179066,4.347917,5.858936,3,-81.176399,1413,1.736111,false,null,33.400002,3.000000,13,10,3,3,30,1,34,3,"NL",0,2.600000,null,null,0,0,8432194,"PBPA","UK162 GERRIT SENIOR","FISHING",23],[244034000,52.099270,4.263852,2.947022,291,-80.416313,757,1.157407,false,null,null,0.000000,4,14,3,3,52,1,42,3,"NL",0,0.000000,null,null,null,null,8873805,"PGLN","OCEAAN","SCHEVENINGEN",25],[249875000,51.951115,4.127117,11.063104,224,-78.025963,500,2.604167,false,186,12.000000,0.000000,193,32,20,12,70,1,40,3,"MT",5,8.300000,4,25,14,0,9342877,"9HA2051","FAIR LADY","ROTTERDAM",26],[244692000,52.154491,4.256585,5.312846,325,-82.359894,730,3.472222,false,184,190.100006,10.200000,23,8,3,3,53,1,42,3,"NL",5,2.400000,null,null,null,null,7117400,"PFRI","MAARTJE","SCHEVENINGEN",28],[211887090,51.953060,3.992640,14.928237,238,-79.682365,344,0.000000,false,33,74.099998,0.000000,140,228,31,20,74,1,40,3,"DE",5,13.600000,5,3,0,0,9708801,"DCOD2","LINAH","DEHAM",31],[246529000,52.097103,4.259702,3.048367,287,-84.217461,237,-1.446759,false,253,null,0.000000,18,5,3,2,36,1,42,3,"NL",0,2.700000,4,28,20,0,null,"PHFY","FANTASTIKO.NL","NL SCHEVENINGEN",33],[219027995,52.013912,3.993563,13.367592,252,-80.679253,215,2.604167,false,306,307.700012,17.700001,23,140,10,11,70,1,42,3,"DK",0,5.900000,5,2,9,10,9198721,"OZCL2","FINLANDIA SEAWAYS","NLVLA",35],[244030593,51.963665,4.123500,10.641197,228,-81.652977,14,-0.289352,false,126,127.000000,6.000000,null,null,null,null,0,1,10,3,"NL",0,0.000000,null,null,null,null,null,"","","",36],[244583000,52.100399,4.267450,2.849534,293,-82.382393,3775,2.604167,false,219,78.500000,0.000000,77,38,7,9,30,1,32810,3,"NL",0,7.300000,null,null,null,null,8901913,"PIWT","SCH123 ZEELAND","FISHINGGROUNDS",37],[244900124,51.960800,4.141087,10.286360,225,-83.242020,328,2.314815,false,356,137.199997,0.000000,11,21,6,6,52,1,42,3,"NL",0,5.500000,1,29,10,0,9695509,"PBRR","VB MARS","ROTTERDAM",56],[277574000,51.990967,4.043417,12.180475,243,-80.672348,9,2.025463,false,100,101.200005,17.000000,null,null,null,null,0,1,2,3,"LT",0,0.000000,null,null,null,null,null,"","","",60],[249671000,51.897984,4.231612,11.713382,199,-80.531281,161,2.025463,false,323,207.300003,0.000000,143,53,15,11,71,1,42,3,"MT",5,6.000000,5,3,7,0,9376713,"9HA4331","VESPERTINE","GBPFT",69],[244010219,52.057045,4.347080,1.511741,167,-79.816307,432,1.157407,false,null,334.899994,4.100000,60,10,10,2,8210,1,298,3,"NL",0,2.150000,4,14,23,0,null,"PF5299","REINOD 6","R.DAM HAVENS",80],[538005884,51.957363,4.128585,10.760972,226,-76.516357,500,1.736111,false,331,343.399994,0.000000,201,36,13,27,70,1,40,3,"MH",5,9.700000,4,21,12,30,9643879,"V7GU4","HARVEST FROST","NL RTM",87],[244767000,52.101715,4.267438,2.882055,294,-78.236023,463,2.025463,false,134,8.000000,0.000000,9,19,4,4,90,1,40,3,"NL",5,2.600000,10,29,13,0,8318180,"PBXD","ISIS","SCHEVENINGEN",93],[305440000,51.890491,4.307520,11.534253,185,-83.255112,54,2.604167,false,349,145.800003,3.300000,null,null,null,null,0,1,10,3,"AG",0,0.000000,null,null,null,null,null,"","","",93],[477345300,51.933384,4.187667,10.502087,212,-80.471535,140,1.446759,false,309,306.000000,0.000000,201,24,20,12,70,1,42,3,"HK",5,8.100000,5,2,3,30,9244362,"VRSU4","XIN YU","ROTTERDAM",95],[440032000,51.929241,4.202748,10.434854,208,-74.246880,514,1.157407,false,null,339.700012,0.000000,15,154,25,15,70,1,40,3,"KR",5,7.000000,4,29,5,30,9623219,"D7GU","SUN RISE","NLRTM",96],[246762000,51.970982,4.136675,9.984998,228,-79.587975,162,2.604167,false,129,129.100006,0.000000,15,197,13,13,61,1,16777258,3,"NL",5,5.500000,5,2,7,15,9469376,"PCIY","STENA TRANSPORTER","NL HVH",99],[235018872,52.098202,4.268382,2.768041,291,-82.355408,91,1.446759,false,36,253.900009,0.000000,6,10,3,3,40,1,42,3,"GB",0,2.000000,4,23,19,0,null,"MFFA6","WINDCAT 1","SCHEVENINGEN<>SURVEY",153],[215640000,51.949635,4.063450,12.886663,232,-79.589561,250,2.604167,false,258,4.000000,0.000000,222,72,10,22,70,1,42,3,"MT",5,11.900001,5,1,10,0,9335202,"9HA5221","GSL CHATEAU DIF","BEANR>NLRTM",158],[244791000,51.961716,4.133683,10.443989,226,-81.213219,171,1.736111,false,319,352.000000,1.100000,null,null,null,null,0,1,10,3,"NL",0,0.000000,null,null,null,null,null,"","","",169],[248743000,51.897995,4.229017,11.745496,200,-81.834915,68,1.736111,false,328,318.500000,1.200000,null,null,null,null,0,1,10,3,"MT",0,0.000000,null,null,null,null,null,"","","",175],[245253000,52.174568,4.341823,5.579835,1,-81.784157,1763,-1.446759,false,25,37.299999,2.800000,16,5,3,2,30,1,16777258,3,"NL",0,0.000000,7,6,10,0,8431463,"PDGH","WR14 JOOST","WIERINGEN",187],[310780000,51.893051,4.286700,11.484280,189,-82.856941,98,3.182870,false,342,72.400002,0.000000,30,300,23,21,69,1,40,3,"BM",5,8.600000,4,20,2,0,9802396,"ZCEV9","SKY PRINCESS","NL RTM",203],[538003853,51.898350,4.285417,11.178819,190,-80.263123,143,1.446759,false,111,114.800003,4.500000,149,34,16,16,89,1,42,3,"MH",0,7.000000,4,28,4,0,9489118,"V7TP5","NAVIG8 CONSTELLATION","NLRTM",232],[244697000,51.959850,4.009767,14.175025,239,-81.447884,133,1.157407,false,357,164.000000,0.000000,16,16,6,6,90,1,42,3,"NL",5,5.300000,6,25,13,9,9489936,"PCWG","VB KRACHT","HARBOR OPS",258],[245872000,51.958000,4.074306,12.261670,232,-79.878998,76,2.893518,false,161,178.900009,0.000000,130,12,10,11,70,1,42,3,"NL",5,6.100000,5,1,19,0,9349227,"PDHA","NJORD","NLRTM",259],[992451973,52.409306,4.075568,21.917273,333,-76.460457,165,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZB3","",260],[992446042,52.183750,4.105300,10.554059,305,-76.085602,161,2.314815,false,null,null,null,2,2,2,2,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OFFSHORE TEST SITE -","",265],[992451974,52.385235,3.949677,23.163628,322,-75.980515,163,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZE4","",265],[992451977,52.256535,3.943923,17.924408,306,-76.104561,161,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZK6","",265],[636022343,51.918770,4.234228,10.510768,201,-81.933899,51,1.157407,false,139,140.600006,10.700000,null,null,null,null,0,1,10,3,"LR",0,0.000000,null,null,null,null,null,"","","",265],[992451978,52.240925,3.948673,17.248238,303,-76.086624,167,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZO5","",265],[992456975,52.257668,4.084667,14.106409,318,-75.902466,166,2.604167,false,null,null,null,40,40,40,40,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OHVS HZB","",265],[992451981,52.259232,4.121473,13.322521,323,-75.984909,162,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZU1","",265],[992451982,52.340668,4.199128,16.373684,341,-76.820999,163,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZV6","",265],[992446044,52.155315,4.102433,9.759516,297,-76.298347,169,2.314815,false,null,null,null,2,2,2,2,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OFFSHORE TEST SITE -","",268],[992451980,52.245888,4.104702,13.088939,318,-75.962921,167,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZS2","",269],[992451983,52.419121,4.256488,20.484186,351,-75.890388,161,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZW5","",269],[992451975,52.346073,3.934937,21.733711,317,-76.560036,169,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZF4","",269],[992451976,52.320374,3.926603,20.858374,313,-75.906105,163,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZG6","",269],[992446043,52.174767,4.128083,9.557960,305,-76.271095,167,3.472222,false,null,null,null,2,2,2,2,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OFFSHORE TEST SITE -","",269],[211266780,52.095329,4.264812,2.836816,286,-77.599617,46,-3.472222,false,null,83.300003,0.000000,17,1,1,5,36,1,17039360,2,"DE",15,0.000000,null,null,null,null,null,"DJGD","GLUECKSBURG","",280],[992456974,52.191116,4.136183,9.936526,311,-76.890106,169,2.893518,false,null,null,null,50,50,50,50,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","Q13A-A PLATFORM","",280],[992451979,52.181721,3.994568,14.024813,295,-76.937698,167,2.893518,false,null,null,null,12,12,12,12,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","WTG HZR6","",280],[992456972,52.319500,4.043167,17.943523,322,-76.096527,163,2.893518,false,null,null,null,40,40,40,40,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OHVS HZA","",280],[992446045,52.165031,4.078050,10.824848,297,-76.339600,165,2.025463,false,null,null,null,2,2,2,2,0,1,2097152,3,"NL",15,0.000000,null,null,null,null,null,"","OFFSHORE TEST SITE -","",280],[477027300,51.891369,4.452712,12.181418,159,-81.562889,12,0.578704,false,286,333.800018,0.000000,178,22,20,13,70,1,16777256,2,"HK",5,7.800000,4,30,4,0,9747508,"VRPK4","FENG XIU HAI","ROTTERDAM",281],[241771000,51.894905,4.299355,11.305254,187,-80.314735,161,1.157407,false,124,120.300003,3.500000,225,49,21,27,80,1,42,3,"GR",0,14.700000,5,2,10,0,9912141,"SVDL7","PACIFIC","NLRTM",345],[244110640,52.031502,4.024632,11.969265,255,-81.986801,1517,2.025463,false,346,349.700012,11.600000,110,24,11,10,33,1,16777258,3,"NL",0,4.000000,8,16,1,0,9822619,"PDEO","ECODELTA","NLDRTM",372],[205233000,51.899048,4.283203,11.152327,190,-82.418571,7,3.472222,false,115,116.000000,4.600000,null,null,null,null,0,1,10,3,"BE",0,0.000000,null,null,null,null,null,"","","",376],[636093117,51.957668,4.039333,13.324203,236,-82.210724,399,-0.289352,false,82,51.000000,0.100000,212,94,13,27,71,1,42,3,"LR",5,9.800000,5,2,8,0,9400095,"5LGN4","KALAHARI EXPRESS","NLRTM",381],[370084000,52.185661,4.233853,7.337942,328,-80.901047,293,1.736111,false,299,17.800001,0.000000,85,35,13,6,84,1,40,3,"PA",1,5.500000,5,1,19,0,9765079,"HOWM","NEW FRONTIER1","NL SCE",417],[245427000,51.961720,4.139272,10.295141,225,-83.203918,83,1.157407,false,40,96.800003,0.000000,20,12,6,6,52,1,42,3,"NL",8,6.100000,3,31,16,0,9448176,"PDIP","VB STINGRAY","ROTTERDAM",420],[357293000,51.937458,4.053337,13.636572,230,-79.834900,184,1.446759,false,249,7.300000,0.000000,251,41,17,28,70,1,40,3,"PA",5,17.400000,4,24,18,30,9767089,"3EVK9","GOOD HORIZON","NL RTM",459],[538010451,51.965683,4.112566,10.867737,230,-79.134399,154,1.446759,false,114,191.000000,0.000000,251,38,28,17,70,1,42,3,"MH",5,17.800001,4,25,3,0,9336012,"V7A6058","SSI INEVITABLE","NLRTM",469],[249287000,51.984535,4.083218,11.084189,238,-81.123192,85,2.314815,false,288,290.399994,12.800000,null,null,null,null,0,1,10,3,"MT",0,0.000000,null,null,null,null,null,"","","",470],[245676000,52.223240,4.295980,8.643263,349,-82.085350,60,2.025463,false,354,13.000000,6.200000,46,3,2,5,36,1,42,3,"NL",0,2.000000,5,2,17,30,8942979,"PFZT","MINERVA [SV]","IJMUIDEN",477],[538003692,51.883327,4.443813,12.529316,161,-80.965660,176,2.893518,false,247,345.899994,0.000000,151,29,18,12,70,1,42,3,"MH",5,9.700000,5,1,23,45,9482770,"V7SO3","TATE J","NLRTM",508],[245209000,51.931881,4.196350,10.413273,210,-82.232491,23,-0.578704,false,124,130.500000,3.100000,null,null,null,null,0,1,10,2,"NL",0,0.000000,null,null,null,null,null,"","","",588],[205533090,51.923775,4.231083,10.275906,202,-80.861267,1,-0.289352,false,null,325.899994,6.400000,null,null,null,null,0,0,2,1,"BE",0,0.000000,null,null,null,null,null,"","","",670],[244100055,51.892342,4.330280,11.370587,181,-81.410309,2,-0.289352,false,null,86.099998,3.600000,15,13,5,3,99,0,34,3,"NL",0,2.600000,12,25,13,0,9239587,"PE8307","RPA11","ROTTERDAM",694],[249532000,51.959999,4.137100,10.424880,225,-80.501160,543,1.736111,false,110,110.000000,8.800000,10,18,4,6,29,1,42,3,"MT",0,4.600000,12,31,0,0,9402433,"9HB4826","VB SCHELDE","ROTTERDAM",719],[215249000,51.975498,4.029683,13.065122,240,-80.267693,202,2.604167,false,111,179.000000,0.000000,273,90,32,14,71,1,40,3,"MT",5,11.200000,5,1,16,0,9410789,"9HA5028","CMA CGM COLUMBA","NLRTM",722],[255805780,51.948086,4.053955,13.221459,232,-81.046867,34,2.604167,false,78,314.600006,0.000000,187,90,10,30,79,1,40,3,"PT",5,9.000000,5,1,3,0,9290787,"CQDD","PANDA 001","ROTTERDAM",728],[244622000,51.906513,4.260183,10.906169,195,-81.602013,8,4.340278,false,null,118.400002,5.200000,null,null,null,null,0,1,10,3,"NL",5,0.000000,null,null,null,null,null,"","","",761],[244780802,52.201214,4.380083,7.340727,12,-82.431770,1535,-3.182870,false,32,39.799999,2.600000,12,8,4,2,30,1,42,3,"NL",7,1.700000,6,24,12,0,null,"PCSS","WL4 HENDERIKA","PLACE TO BE",782],[538007572,52.182838,4.216348,7.559499,323,-80.068588,275,4.340278,false,270,105.400002,0.000000,148,29,8,20,70,1,40,3,"MH",1,10.100000,5,13,18,0,9594456,"V7GQ4","SEAHORSE","USILM",821],[244740767,52.098919,4.270713,2.704123,292,-82.333748,47,-0.289352,false,null,null,0.000000,null,null,null,null,0,1,8,3,"NL",5,0.000000,null,null,null,null,null,"","","",863],[220589000,51.910839,4.421240,10.703155,163,-81.511055,1,3.182870,false,23,24.900000,2.000000,null,null,null,null,0,0,2,2,"DK",5,0.000000,null,null,null,null,null,"","","",865],[244454000,52.009907,3.971992,14.200069,252,-81.871826,800,-0.289352,false,282,288.399994,8.000000,0,0,0,0,55,1,42,3,"NL",3,5.000000,4,4,19,0,9167966,"PDHT","ARCA","SURVEY",927],[305149000,51.930832,4.195237,10.488415,210,-80.459175,19,2.025463,false,134,127.000000,3.900000,null,null,null,null,0,1,10,3,"AG",0,0.000000,null,null,null,null,null,"","","",983],[244833000,51.905392,4.266333,10.913305,194,-83.617218,4,-0.289352,false,307,308.399994,2.600000,null,null,null,null,0,1,8,2,"NL",3,0.000000,null,null,null,null,null,"","","",983],[244730912,51.895271,4.330122,11.194880,181,-83.051651,1,0.868056,false,null,267.100006,9.000000,null,null,null,null,0,0,2,2,"NL",0,0.000000,null,null,null,null,null,"","","",1007],[244620628,51.931438,4.195827,10.445886,210,-79.394157,1,4.340278,false,null,129.600006,9.000000,null,null,null,null,0,0,2,1,"NL",0,0.000000,null,null,null,null,null,"","","",1007],[305435000,51.900646,4.278710,11.089864,191,-80.519203,59,2.314815,false,116,108.200005,4.100000,null,null,null,null,0,1,10,3,"AG",0,0.000000,null,null,null,null,null,"","","",1047],[255805897,51.959213,4.059542,12.657476,234,-80.660286,33,2.893518,false,263,228.000000,0.000000,109,191,32,16,70,1,40,3,"PT",5,11.300000,5,1,8,30,9720500,"CQYR","MSC SASHA","BEANR>>NLRTM",1083],[219029722,51.916607,4.203681,11.090769,206,-80.837822,66,0.868056,false,359,273.000000,0.000000,122,25,19,3,80,1,42,3,"DK",5,7.000000,5,2,14,0,9909649,"OZBH2","TERN ISLAND","ROTTERDAM",1125],[309504000,52.210094,4.225813,8.756678,331,-82.316612,182,1.446759,false,269,230.400009,0.100000,230,44,33,15,80,1,42,3,"BS",1,9.400001,5,2,4,0,9379210,"C6XA2","SHENLONG SPIRIT","NL RTM > NL SCE",1158],[248352000,51.958633,4.140685,10.389024,224,-81.117058,179,1.736111,false,61,82.300003,7.200000,10,19,10,3,52,1,42,3,"MT",0,6.000000,null,null,null,null,9816658,"9HA4625","ROTTERDAM","R0TTERDAM",1221],[215928000,51.909771,4.257070,10.749287,196,-81.472252,1,3.761574,false,303,303.300018,8.200000,null,null,null,null,0,0,2,1,"MT",0,0.000000,null,null,null,null,null,"","","",1256],[245906000,51.889874,4.307882,11.569871,185,-82.366402,1,2.893518,false,34,28.400000,6.800000,null,null,null,null,0,0,2,1,"NL",0,0.000000,null,null,null,null,null,"","","",1264],[205565000,51.953175,4.138972,10.668566,223,-82.839432,17,1.736111,false,281,16.200001,0.000000,null,null,null,null,0,1,10,3,"BE",0,0.000000,null,null,null,null,null,"","","",1329],[244060924,51.951172,4.075598,12.477501,231,-78.597534,35,2.025463,false,null,null,0.100000,null,null,null,null,0,1,10,3,"NL",5,0.000000,null,null,null,null,null,"","","",1362],[244805000,52.099167,4.269833,2.739846,292,-81.975334,59,2.604167,false,306,193.300003,0.000000,12,8,5,1,34,1,40,3,"NL",5,3.000000,null,null,0,0,8433198,"PHEN","AQUILA","DIVING",1422],[211645160,52.190853,4.299555,6.710873,347,-83.728630,3,-1.157407,false,null,18.700001,6.600000,null,null,null,null,0,1,262144,3,"DE",15,0.000000,null,null,null,null,null,"","","",1431],[249522000,51.937084,4.181016,10.449031,213,-81.349724,245,-3.182870,false,224,274.000000,0.800000,12,16,6,5,52,1,42,3,"MT",0,4.800000,1,1,0,0,9476408,"9HB4830","VB EBRO","SCHIEDAM",1434],[255806413,51.961418,4.139163,10.310786,225,-82.699005,370,-2.893518,false,21,344.700012,0.500000,null,null,null,null,0,1,10,3,"PT",0,0.000000,null,null,null,null,null,"","","",1449],[244850970,51.879192,4.417455,12.502486,166,-81.610458,325,1.736111,false,290,112.099998,0.300000,132,10,10,11,71,1,42,3,"NL",0,5.800000,4,30,9,0,9302243,"PBTF","SVEN D","NLRTM",1573]],"error":false}';
                ships = JSON.parse(ships_json);
            }
            setPulseOk();


            const keys = ["mmsi", "lat", "lon", "distance", "bearing", "level", "count", "ppm", "approx", "heading", "cog", "speed", "to_bow", "to_stern", "to_starboard", "to_port", "shiptype", "validated", "msg_type", "channels", "country", "status", "draught", "eta_month", "eta_day", "eta_hour", "eta_minute", "imo", "callsign", "shipname", "destination", "last_signal"];

            shipsDB = {};
            ships.values.forEach(v => {

                const s = Object.fromEntries(keys.map((k, i) => [k, v[i]]));

                if (includeShip(s)) {
                    const entry = {};
                    s.mmsi_type = getMMSItype(s);
                    entry.raw = s;
                    shipsDB[s.mmsi] = entry;
                }
            });

            if (ships.hasOwnProperty("station"))
                station = ships.station;

            center = {};
            if (String(settings.center_point).toUpperCase() == "STATION") {
                center = station;
            }
            else if (settings.center_point in shipsDB) {
                let ship = shipsDB[settings.center_point].raw;
                center = { lat: ship.lat, lon: ship.lon };
            }

            return ships.values.length;
        }

        function toggleScreenSize() {
            var doc = window.document;
            var docEl = doc.documentElement;

            var requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen || docEl.webkitEnterFullscreen;
            var cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen || doc.webkitExitFullscreen;

            if (!doc.fullscreenElement && !doc.mozFullScreenElement && !doc.webkitFullscreenElement && !doc.msFullscreenElement) {
                requestFullScreen.call(docEl);
            }
            else {
                cancelFullScreen.call(doc);
            }
        }

        function addShipcardItem(icon, txt, title, onclick) {

            const div = document.createElement('div');

            div.title = title;
            div.innerHTML = '<i class="' + icon + ' fa-xl"></i><span>' + txt + '</span>';
            div.setAttribute("onclick", onclick);

            document.getElementById('shipcard_footer').appendChild(div);
        }

        function hideMenu() {
            if (document.getElementById("menubar").classList.contains('visible')) {
                toggleMenu();
            }
        }

        function hideMenuifSmall() {
            //if(window.matchMedia("(max-height: 1000px)").matches)
            // always hide
            hideMenu();
        }

        function toggleMenu() {
            document.getElementById("menubar").classList.toggle('visible');
            document.getElementById("menubar_mini").classList.toggle('show');

            document.getElementById("header_menu_button").classList.toggle("fa-bars");
            document.getElementById("header_menu_button").classList.toggle("fa-xmark");
        }

        function initFullScreen() {
            document.addEventListener("fullscreenchange", handleFullScreenChange);
            document.addEventListener("mozfullscreenchange", handleFullScreenChange);
            document.addEventListener("webkitfullscreenchange", handleFullScreenChange);
            document.addEventListener("msfullscreenchange", handleFullScreenChange);
        }

        function handleFullScreenChange() {
            var icon = document.getElementById("screentoggle-id");
            if (document.fullscreenElement) {
                icon.classList.remove("fs-icon-normal");
                icon.classList.add("fs-icon-full");

            } else {
                icon.classList.remove("fs-icon-full");
                icon.classList.add("fs-icon-normal");
            }
        }

        // we calculate the lat/lon for 1m move in direction of heading
        // underlying calculation uses an offset of 100m and then scales down to 1.

        const cos100R = 0.9999999998770914;     // cos(100m / R);
        const sin100R = 1.567855942823164e-05;  // sin(100m / R)
        const rad = Math.PI / 180;
        const radInv = 180 / Math.PI;

        function calcOffset1M(latlng, heading) {

            const lat = latlng.lat * rad;

            const rheading = ((heading + 360) % 360) * rad;
            const sinLat = Math.sin(lat);
            const cosLat = Math.cos(lat);

            let sinLat2 = sinLat * cos100R + cosLat * sin100R * Math.cos(rheading);
            let lat2 = Math.asin(sinLat2);
            let deltaLon = Math.atan2(Math.sin(rheading) * sin100R * cosLat, cos100R - sinLat * sinLat2);

            // normalize to 1 meter (from 100m)
            return [(lat2 * radInv - latlng.lat) / 100, (deltaLon * radInv) / 100];
        }

        function calcMove(latlng, delta, distance) {
            return L.latLng([latlng.lat + delta[0] * distance, latlng.lng + delta[1] * distance]);
        }

        function drawShipOutline(ship) {

            if (ship == null) return;

            let style = {};

            const latlng = L.latLng(ship.lat, ship.lon);
            const to_bow = ship.to_bow, to_stern = ship.to_stern, to_port = ship.to_port, to_starboard = ship.to_starboard;
            let heading = ship.heading;

            if (to_bow == null || to_stern == null || to_port == null || to_starboard == null) return;

            if (heading == null) {
                style.dashArray = '5, 5';
                style.dashOffset = '0';

                if (ship.cog != null && ship.speed > 1) heading = ship.cog;
            }


            let col = { color: 'grey', fillColor: 'grey' };
            if (ship.mmsi == hover_mmsi) col = { color: 'orange', fillColor: 'orange' };
            else if (ship.mmsi == card_mmsi) col = { color: '#943b3e', fillColor: '#943b3e' };

            if (heading != null) {
                const deltaBow = calcOffset1M(latlng, (heading) % 360);
                const deltaStarboard = calcOffset1M(latlng, (heading + 90) % 360);

                const bow = calcMove(latlng, deltaBow, to_bow);
                const stern = calcMove(latlng, deltaBow, -to_stern);

                const A = calcMove(stern, deltaStarboard, to_starboard);
                const B = calcMove(stern, deltaStarboard, -to_port);
                const C = calcMove(B, deltaBow, 0.8 * (to_bow + to_stern));
                const Dmid = calcMove(C, deltaStarboard, 0.5 * (to_starboard + to_port));
                const D = calcMove(Dmid, deltaBow, 0.2 * (to_bow + to_stern));
                const E = calcMove(C, deltaStarboard, to_starboard + to_port);

                const ship_outline = [];

                ship_outline.push(A);
                ship_outline.push(B);
                ship_outline.push(C);
                ship_outline.push(D);
                ship_outline.push(E);

                return L.polygon(ship_outline, { ...col, fillOpacity: 0.2, ...style }).addTo(map);
            }
            else {

                const a = Math.max(to_bow, to_stern), b = Math.max(to_starboard, to_port);
                const r = Math.sqrt(a * a + b * b);

                if (r < 2 || r > 300) return null;
                return L.circle(latlng, { radius: r, ...col, fillOpacity: 0.2, ...style }).addTo(map);
            }

            return null;
        }

        function average(d) {
            const b = d.chart.data.datasets[0].data;
            if (b.length == 1) return b[0].y;

            var c = 0;
            for (a = 0; a < b.length; a++) {
                if (b[a].x != 0) {
                    for (i = 0; i < d.chart.data.datasets.length; i++) {
                        c += d.chart.data.datasets[i].data[a].y;
                    }
                }
            }
            return c / (b.length - 1);
        }

        const graph_annotation = {
            type: 'line',
            borderColor: 'rgba(12,118,170)',
            borderDash: [6, 6],
            borderDashOffset: 0,
            borderWidth: 3,
            scaleID: 'y',
            value: a => average(a)
        };

        const graph_options_count = {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                },
                annotation: {
                    annotations: {
                        graph_annotation
                    }
                }
            },
            elements: {
                point: {
                    radius: 1
                }
            },
            animation: false,
            tooltips: {
                mode: 'index',
                intersect: false
            },
            hover: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        display: true
                    }
                },
                x: {
                    ticks: {
                        display: true
                    }
                }
            }
        };


        const graph_options_single = {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                },
                annotation: {
                    annotations: {
                        graph_annotation
                    }
                }
            },
            elements: {
                point: {
                    radius: 1
                }
            },
            animation: false,
            tooltips: {
                mode: 'index',
                intersect: false
            },
            hover: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: {
                        display: true
                    }
                },
                x: {
                    ticks: {
                        display: true
                    }
                }
            }
        };

        const graph_options_level = {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            elements: {
                point: {
                    radius: 1
                }
            },
            animation: false,
            tooltips: {
                mode: 'index',
                intersect: false
            },
            hover: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        display: true
                    }
                },
                x: {
                    ticks: {
                        display: true
                    }
                }
            }
        };

        const graph_options_distance = {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                }
            },
            elements: {
                point: {
                    radius: 1
                }
            },
            animation: false,
            tooltips: {
                mode: 'index',
                intersect: false
            },
            hover: {
                mode: 'index',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        display: true
                    }
                },
                x: {
                    ticks: {
                        display: true
                    }
                }
            }
        };

        plot_count = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Class A',
                    data: [],
                    showLine: true,
                    fill: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart1-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart1-color'),
                    borderWidth: 2,
                    pointStyle: false
                },
                {
                    label: 'Class B',
                    data: [],
                    showLine: true,
                    fill: '-1',
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart2-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart2-color'),
                    borderWidth: 2,
                    pointStyle: false
                },
                {
                    label: 'Base Station',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart5-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart5-color'),
                    fill: '-1',
                    borderWidth: 2,
                    pointStyle: false
                },
                {
                    label: 'Other',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    fill: '-1',
                    borderWidth: 2,
                    pointStyle: false
                }]
            },
            options: graph_options_count
        };


        plot_distance = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'NE',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart1-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart1-color'),
                    pointStyle: false,
                    borderWidth: 2
                },
                {
                    label: 'SE',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart2-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart2-color'),
                    pointStyle: false,
                    borderWidth: 2
                }, {
                    label: 'SW',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart3-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart3-color'),
                    pointStyle: false,
                    borderWidth: 2
                },
                {
                    label: 'NW',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    pointStyle: false,
                    borderWidth: 2
                },
                {
                    label: 'Max',
                    data: [],
                    showLine: true,
                    backgroundColor: 'rgb(211,211,211,0.9)',
                    fill: true,
                    pointStyle: false,
                    borderWidth: 0
                }]
            },
            options: graph_options_distance
        };

        plot_single = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Data',
                    data: [],
                    showLine: true,
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    borderColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    pointStyle: false,
                    borderWidth: 2
                }]
            },
            options: graph_options_single
        };

        plot_level = {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Max',
                    data: [],
                    showLine: true,
                    pointStyle: false,
                    borderWidth: 1
                }, {
                    label: 'Min',
                    data: [],
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart1-color'),
                    showLine: true,
                    pointStyle: false,
                    borderWidth: 1,
                    fill: '-1'
                }]
            },
            options: graph_options_level
        };


        var plot_radar = {
            type: "polarArea",
            animation: false,
            responsive: true,
            plugins: {
                legend: {
                    display: true
                }
            },
            data: {
                datasets: [{
                    label: 'Class B',
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart2-color'),
                    borderWidth: 1
                }, {
                    label: 'Class A',
                    backgroundColor: getComputedStyle(document.body).getPropertyValue('--chart4-color'),
                    borderWidth: 1
                }]
            },
            options: {
                legend: {
                    display: false
                },
                scale: {
                    ticks: {
                        min: 0,
                    }
                }
            }
        };

        function initPlots() {
            chart_radar_hour = new Chart(document.getElementById('chart-radar-hour').getContext("2d"), plot_radar);
            chart_radar_day = new Chart(document.getElementById('chart-radar-day').getContext("2d"), plot_radar);
            chart_seconds = new Chart(document.getElementById('chart-seconds'), plot_count);
            chart_minutes = new Chart(document.getElementById('chart-minutes'), plot_count);
            chart_hours = new Chart(document.getElementById('chart-hours'), plot_count);
            chart_days = new Chart(document.getElementById('chart-days'), plot_count);
            chart_ppm = new Chart(document.getElementById('chart-ppm'), plot_single);
            chart_ppm_minute = new Chart(document.getElementById('chart-ppm-minute'), plot_single);
            chart_level = new Chart(document.getElementById('chart-level'), plot_level);
            chart_distance_hour = new Chart(document.getElementById('chart-distance-hour'), plot_distance);
            chart_distance_day = new Chart(document.getElementById('chart-distance-day'), plot_distance);
        }

        function shipcardismax() {
            return document.getElementById('shipcard').classList.contains('shipcard-ismax');
        }
        function shipcardselect(e) {
            if (shipcardismax()) {
                e.classList.toggle('shipcard-max-only');
                e.classList.toggle('shipcard-row-selected');
            }
            else
                toggleShipcardSize();
        }

        function toggleShipcardSize() {

            Array.from(document.getElementsByClassName('shipcard-min-only')).forEach(e => e.classList.toggle("visible"));
            Array.from(document.getElementsByClassName('shipcard-max-only')).forEach(e => e.classList.toggle("hide"));

            document.getElementById('shipcard').classList.toggle('shipcard-ismax');

            var e = document.getElementById('shipcard_content').children;

            if (shipcardismax()) {
                for (let i = 0; i < e.length; i++) {
                    if (e[i].classList.contains('shipcard-max-only') && e[i].classList.contains('shipcard-row-selected') ||
                        !e[i].classList.contains('shipcard-max-only') && !e[i].classList.contains('shipcard-row-selected'))
                        e[i].classList.toggle('shipcard-row-selected');
                }
            }
            else {
                for (let i = 0; i < e.length; i++) {
                    if (e[i].classList.contains('shipcard-row-selected'))
                        e[i].classList.toggle('shipcard-row-selected');
                }
            }
        }

        function setPulseOk() {
            document.getElementById("pulse-id").className = "header-pulse-ok";
        }

        function setPulseError() {
            document.getElementById("pulse-id").className = "header-pulse-error";
        }

        function getFlag(country) {
            return country ? `<span style="padding-right: 10px" title="` + country + `" class="fi fi-${country.toLowerCase()}"></span> ` : "";

        }

        // fetches main statistics from the server
        async function fetchStatistics() {
            try {
                response = await fetch('stat.json');
            } catch (error) {
                setPulseError();
                return;
            }
            statistics = await response.json();
            setPulseOk();
            return statistics;
        }

        async function updateStatistics() {
            var stat = await fetchStatistics();

            if (stat) {
                // in bulk....
                ['build_describe', 'build_date', 'station', 'product', 'vendor', 'serial', 'model', 'sample_rate', 'received', 'vessel_count'].forEach(e => document.getElementById('stat_' + e).innerHTML = stat[e]);
                ['stat', 'last_minute', 'last_day', 'last_hour'].forEach(e => document.getElementById('stat_' + e + '_count').innerHTML = stat[e].count);
                [0, 1, 2, 3].forEach(e => document.getElementById('stat_stat_channel' + e).innerHTML = stat.stat.channel[e]);

                // special formatting
                document.getElementById("stat_msg_rate").innerHTML = Number(stat.msg_rate).toFixed(1) + " msg/s";
                document.getElementById("stat_run_time").innerHTML = getDeltaTimeVal(stat.run_time);

                document.getElementById("stat_stat_msg123").innerHTML = stat.stat.msg[0] + stat.stat.msg[1] + stat.stat.msg[2];
                document.getElementById("stat_stat_msg5").innerHTML = stat.stat.msg[4];
                document.getElementById("stat_stat_msg1819").innerHTML = stat.stat.msg[17] + stat.stat.msg[18];
                document.getElementById("stat_stat_msg24").innerHTML = stat.stat.msg[23];
                document.getElementById("stat_stat_msg4").innerHTML = stat.stat.msg[3];
                document.getElementById("stat_stat_msg9").innerHTML = stat.stat.msg[8];
                document.getElementById("stat_stat_msg21").innerHTML = stat.stat.msg[20];

                var count_other = 0;
                [6, 7, 8, 10, 11, 12, 13, 14, 15, 16, 17, 20, 22, 23, 25, 26, 27].forEach(i => count_other += stat.stat.msg[i - 1]);
                document.getElementById("stat_stat_msgother").innerHTML = count_other;

                if (stat.station_link != "")
                    document.getElementById("stat_station").innerHTML = "<a href='" + stat.station_link + "'>" + stat.station + "</a>";

                var title = document.getElementById("stat_station").textContent;
                if (title != "" && title != null) document.title = "AIS-catcher " + title;
            }
        }

        function updateChartMulti(b, f, c) {
            if (b.hasOwnProperty(f)) {
                var hA = [];
                var hB = [];
                var hT = [];
                var hS = [];

                const source = b[f];
                for (let i = 0; i < source.time.length; i++) {
                    let cA = source.stat[i].msg[0] + source.stat[i].msg[1] + source.stat[i].msg[2] + source.stat[i].msg[4];
                    hA.push({ x: source.time[i], y: cA });
                    let cB = source.stat[i].msg[17] + source.stat[i].msg[18] + source.stat[i].msg[23];
                    hB.push({ x: source.time[i], y: cB });
                    let cS = source.stat[i].msg[3];
                    hS.push({ x: source.time[i], y: cS });
                    let cT = source.stat[i].count - cA - cB - cS;
                    hT.push({ x: source.time[i], y: cT });
                }
                c.data.datasets[0].data = hA;
                c.data.datasets[1].data = hB;
                c.data.datasets[2].data = hS;
                c.data.datasets[3].data = hT;

                c.update();
            }
        }

        function updateChartDistance(b, f, c) {
            if (b.hasOwnProperty(f)) {
                var hNE = [];
                var hSE = [];
                var hSW = [];
                var hNW = [];
                var hM = [];

                let source = b[f];

                if (source.stat[0].radar_a.length == 0) return;
                let N = source.stat[0].radar_a.length;
                let N4 = N / 4;
                for (let i = 0; i < source.time.length; i++) {
                    let count = [0, 0, 0, 0];
                    for (let j = 0; j < N; j++)
                        count[Math.floor(j / N4)] = Math.max(count[Math.floor(j / N4)], source.stat[i].radar_a[j]);

                    hNE.push({ x: source.time[i], y: getDistanceConversion(count[0]) }); // source.stat[i].radar[0]
                    hSE.push({ x: source.time[i], y: getDistanceConversion(count[1]) });
                    hSW.push({ x: source.time[i], y: getDistanceConversion(count[2]) });
                    hNW.push({ x: source.time[i], y: getDistanceConversion(count[3]) });
                    hM.push({ x: source.time[i], y: getDistanceConversion(source.stat[i].dist) });
                }
                c.data.datasets[0].data = hNE;
                c.data.datasets[1].data = hSE;
                c.data.datasets[2].data = hSW;
                c.data.datasets[3].data = hNW;
                c.data.datasets[4].data = hM;

                c.update();
            }
        }

        function updateChartSingle(b, f1, f2, c) {
            if (b.hasOwnProperty(f1)) {
                var h = [];

                const source = b[f1];
                for (let i = 0; i < source.time.length; i++) {
                    h.push({ x: source.time[i], y: source.stat[i][f2] });
                }
                c.data.datasets[0].data = h;
                c.update();
            }
        }

        function updateChartLevel(b, f1, f2, c) {
            if (b.hasOwnProperty(f1)) {
                const source = b[f1];

                var h = [];

                for (let i = 0; i < source.time.length; i++) {
                    h.push({ x: source.time[i], y: source.stat[i].level_min == 0 ? null : source.stat[i].level_min });
                }
                c.data.datasets[1].data = h;

                var h = [];
                for (let i = 0; i < source.time.length; i++) {
                    h.push({ x: source.time[i], y: source.stat[i].level_max == 0 ? null : source.stat[i].level_max });
                }
                c.data.datasets[0].data = h;

                c.update();
            }
        }

        function updateRadar(b, f, c) {
            if (b.hasOwnProperty(f)) {
                var data_a = [], data_b = [];
                let idx = 0;
                if (b[f].stat.length > 1) idx = 1;
                let N = b[f].stat[idx].radar_a.length;
                for (var i = 0; i < N; i++) {
                    data_a.push({
                        r: getDistanceConversion(b[f].stat[idx].radar_a[i]),
                        theta: i * 360 / N
                    });
                    data_b.push({
                        r: getDistanceConversion(b[f].stat[idx].radar_b[i]),
                        theta: i * 360 / N
                    });
                }
                c.data.datasets[0].data = data_b;
                c.data.datasets[1].data = data_a;
                c.update();
            }

        }

        async function updatePlots() {

            const unit = getDistanceUnit().toUpperCase();
            document.querySelectorAll('.distunit').forEach(u => { u.textContent = unit; });

            if (true) {
                try {
                    response = await fetch('history_full.json');
                } catch (error) {
                    setPulseError();
                }
                b = await response.json();
            }
            else {
                b = JSON.parse(chart_json);
            }
            setPulseOk();

            updateChartMulti(b, 'second', chart_seconds);
            updateChartMulti(b, 'minute', chart_minutes);
            updateChartMulti(b, 'hour', chart_hours);
            updateChartMulti(b, 'day', chart_days);

            updateChartSingle(b, 'minute', 'ppm', chart_ppm_minute);
            updateChartSingle(b, 'hour', 'ppm', chart_ppm);
            updateChartLevel(b, 'minute', 'level', chart_level);

            //plot_radar.options.ticks.scale.max = 200;
            updateChartDistance(b, 'hour', chart_distance_hour);
            updateChartDistance(b, 'day', chart_distance_day);

            updateRadar(b, 'hour', chart_radar_hour);
            updateRadar(b, 'day', chart_radar_day);
        }

        function tableRowClick(m) {
            ship = shipsDB[m].raw;
            if (ship.lat == null || ship.lon == null) return;

            selectMapTab(m);
        }

        function sortTable(e) {

            settings.sort = e.getAttribute('field');
            settings.sort_dir = settings.sort_dir == "asc" ? "dec" : "asc";

            saveSettings();
            updateShipTable()
        }

        async function updateShipTable() {

            await fetchShips();

            const mmsi_sorted = Object.keys(shipsDB).sort(function (a_mmsi, b_mmsi) {

                let d1 = shipsDB[a_mmsi].raw[settings.sort];
                let d2 = shipsDB[b_mmsi].raw[settings.sort];

                // Some vessel names start with space, to avoid they end up at the bottom or start of the table
                //if(typeof d1 === "string") d1 = d1.trim();
                //if(typeof d2 === "string") d2 = d2.trim();

                dm = a_mmsi - b_mmsi;
                if (d1 == null || d1 === "") {
                    if (d1 === d2) return dm;
                    return 1;
                }
                if (d2 === null || d2 === "") return -1;

                if (settings.sort_dir == "asc")
                    return d1 < d2 ? -1 : d1 > d2 ? 1 : dm;
                else
                    return d1 > d2 ? -1 : d1 < d2 ? 1 : dm;
            });

            c = document.getElementById("shipTableBody"), c.innerHTML = "";

            for (b = 0; b < mmsi_sorted.length; b++) {

                const ship = shipsDB[mmsi_sorted[b]].raw;
                const row = c.insertRow();

                row.setAttribute("mmsi", ship.mmsi);
                row.setAttribute("onclick", "tableRowClick(" + ship.mmsi + ");");
                row.setAttribute("oncontextmenu", "showContextMenu(event, " + ship.mmsi + ",['mmsi']);");


                let nameCell = row.insertCell(0); nameCell.innerHTML = getFlag(ship.country) + getShipName(ship);

                let valid = "";
                switch (ship.validated) {
                    case 1: valid = "Yes"; nameCell.className = "shipcard-validated"; break;
                    case -1: valid = "No"; nameCell.className = "shipcard-dubious"; break;
                    default: valid = "Pending"; nameCell.className = "shipcard-not-validated-transparant"; break;
                }

                row.insertCell(1).innerHTML = ship.mmsi;
                row.insertCell(2).innerHTML = getCallSign(ship);
                row.insertCell(3).innerHTML = getDeltaTimeVal(ship.last_signal);
                row.insertCell(4).innerHTML = ship.count;
                row.insertCell(5).innerHTML = Number(ship.ppm).toFixed(1);
                row.insertCell(6).innerHTML = Number(ship.level).toFixed(1);

                if (ship.distance != null && ship.bearing != null) {
                    row.insertCell(7).innerHTML = getDistanceVal(ship.distance);
                    row.insertCell(8).innerHTML = Number(ship.bearing).toFixed(0) + '&deg';
                } else {
                    row.insertCell(7).innerHTML = row.insertCell(8).innerHTML = "";
                }

                if (ship.lat != null && ship.lon != null) {
                    cell = row.insertCell(9); cell.innerHTML = getLatVal(ship); cell.setAttribute("valid", valid);
                    cell = row.insertCell(10); cell.innerHTML = getLonVal(ship); cell.setAttribute("valid", valid);
                } else {
                    row.insertCell(9).innerHTML = "";
                    row.insertCell(10).innerHTML = "";
                }

                row.insertCell(11).innerHTML = valid;
                row.insertCell(12).innerHTML = getStringfromChannels(ship.channels);
            }
        }

        function getTooltipContent(ship) {
            return getFlag(ship.country) + `<b>${getShipName(ship) || "MMSI: " + ship.mmsi}</b><br>${getDeltaTimeVal(ship.last_signal)} ago`;
        }

        function getTypeVal(ship) {
            switch (ship.mmsi_type) {
                case CLASS_A:
                    return "Ship (Class A)";
                case CLASS_B:
                    return "Ship (Class B)";
                case BASESTATION:
                    return "Base Station";
                case SAR:
                    return "SAR aircraft"
                case SARTEPIRB:
                    return "AIS SART/EPIRB";
                case ATON:
                    return "Aid-to-Navigation";
            }
            return "Unknown";
        }

        function getIcon(ship) {

            const STATICON = 0;
            const SHIPICON = 1;
            const PLANEICON = 2;
            const HELICOPTERICON = 3;

            let shipicon = SHIPICON; c = 120;
            switch (getShipTypeClass(ship)) {
                case ShippingClass.CARGO:
                    shipicon = SHIPICON; c = 0; break;
                case ShippingClass.TANKER:
                    shipicon = SHIPICON; c = 80; break;
                case ShippingClass.PASSENGER:
                    shipicon = SHIPICON; c = 40; break;
                case ShippingClass.HIGHSPEED:
                    shipicon = SHIPICON; c = 100; break;
                case ShippingClass.SPECIAL:
                    shipicon = SHIPICON; c = 60; break;
                case ShippingClass.FISHING:
                    shipicon = SHIPICON; c = 140; break;
                case ShippingClass.ATON:
                    shipicon = STATICON; c = 0; break;
                case ShippingClass.PLANE:
                    shipicon = PLANEICON; break;
                case ShippingClass.HELICOPTER:
                    shipicon = HELICOPTERICON; break;
                case ShippingClass.B:
                    shipicon = SHIPICON; c = 20; break;
                case ShippingClass.STATION:
                    shipicon = STATICON; c = 20; break;
                case ShippingClass.SARTEPIRB:
                    c = 60; shipicon = STATICON; break;
            }

            switch (shipicon) {
                case STATICON:
                    return L.icon({iconUrl: statpng, iconSize: [20, 20], iconAnchor: [10, 10],iconOffset: [c,0],rotationAngle: 0 });
                case SHIPICON:
                    if (ship.speed != null && ship.speed > 0.5 && ship.cog != null)
                        return L.icon({iconUrl: shippng, iconSize: [20, 20], iconAnchor: [10, 10],iconOffset: [c,0],rotationAngle: ship.cog });
                    else
                        return L.icon({iconUrl: shippng, iconSize: [20, 20], iconAnchor: [10, 10],iconOffset: [c,20],rotationAngle: ship.cog });
                case PLANEICON:
                    return L.icon({iconUrl: planepng, iconSize: [25, 25], iconAnchor: [12, 12],iconOffset: [0,0],rotationAngle: ship.cog });
                case HELICOPTERICON:
                   return L.icon({iconUrl: helicopterpng, iconSize: [25, 25], iconAnchor: [12, 12],iconOffset: [0,0],rotationAngle: ship.cog });
                default:
                    console.log("Error: shipicon undefined.");
            }

            return null;
        }

        // Inspired by: https://gis.stackexchange.com/questions/382087/how-to-remove-leaflet-tooltip-label-collision
        function hasOverlap(r1, r2) {
            return (!(r1.right < r2.left || r1.left > r2.right || r1.bottom < r2.top || r1.top > r2.bottom));
        }

        function addTooltip(rects, m) {
            m.openTooltip();
            const r = m.getTooltip()._container.getBoundingClientRect();

            for (var i = 0; i < rects.length; i++) {
                if (hasOverlap(r, rects[i])) {
                    m.getTooltip().toggle();
                    return;
                }
            }

            rects.push(r);
        }

        function updateTooltips() {
            if (!settings.labels) return;

            let rects = [];

            if (hover_mmsi in markers) addTooltip(rects, markers[hover_mmsi]);
            if (card_mmsi in markers) addTooltip(rects, markers[card_mmsi]);

            for (let [mmsi, m] of Object.entries(markers)) {
                if (mmsi == card_mmsi || mmsi == hover_mmsi) continue;
                addTooltip(rects, m);
            }
        }

        function startHover(m) {

            if (hover_mmsi != null) endHover(hover_mmsi);

            hover_mmsi = m;

            if (!settings.labels) {
                if (hover_mmsi != null && hover_mmsi in markers) {
                    markers[hover_mmsi].openTooltip();
                }
            }
            else {
                updateTooltips();
            }

            let ship = shipsDB[hover_mmsi].raw;
            plotShip(ship);
        }

        function endHover(m) {
            let ship = shipsDB[hover_mmsi].raw;
            m = hover_mmsi;
            hover_mmsi = null;

            if (!settings.labels) {
                if (m != null && m in markers)
                    markers[m].closeTooltip();
            }
            else {
                updateTooltips();
            }
            if (ship) plotShip(ship);
            clearHoverMarker();

        }

        function saveSettings() {

            settings.lat = map.getCenter().lat;
            settings.lon = map.getCenter().lng;
            settings.zoom = map.getZoom();

            localStorage.settings = JSON.stringify(settings);
        }

        function loadSettings() {
            try {
                ls = JSON.parse(localStorage.settings);
            } catch (error) {
                console.log(error);
                return;
            }
            settings = { ...settings, ...ls };
        }

        function loadSettingsFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            for (const [key, value] of urlParams.entries())
                if (settings.hasOwnProperty(key))
                    settings = { ...settings, [key]: value };
        }

        function updateShipShape(ship) {
            return;

            if (ship.mmsi in ship_shape)
                if (ship_shape[ship.mmsi] != null)
                    map.removeLayer(ship_shape[ship.mmsi]);

            ship_shape[ship.mmsi] = drawShipOutline(ship);
        }

        function plotShip(ship) {
            /*
            if (ship.mmsi in markers) {
                if (ship.mmsi != hover_mmsi) markers[ship.mmsi].setIcon(getIcon(ship)); // bug in leaflet??
                markers[ship.mmsi].setLatLng([ship.lat, ship.lon]);
                markers[ship.mmsi].getTooltip().setContent(getTooltipContent(ship));

            } else {
                markers[ship.mmsi] = L.marker([ship.lat, ship.lon], { icon: getIcon(ship) }).addTo(map);

                markers[ship.mmsi].on('click', function (e) { showShipcard(ship.mmsi); });
                markers[ship.mmsi].on('mouseover', function (e) { startHover(ship.mmsi); });
                markers[ship.mmsi].on('mouseout', function (e) { endHover(ship.mmsi); });
                markers[ship.mmsi].on('contextmenu', function (e) { showContextMenu(event, ship.mmsi, ['mmsi', 'mmsi-map']); });

                markers[ship.mmsi].bindTooltip(getTooltipContent(ship), { opacity: 0.85, permanent: false, offset: [15, 0], direction: 'right' });
                markers[ship.mmsi].closeTooltip();
            }
            */
            updateShipShape(ship);
            if (hover_mmsi == ship.mmsi)
                setHoverMarker([ship.lat, ship.lon]);
        }

        function mapResetView(z, m) {
            if (m && m in shipsDB) {
                let ship = shipsDB[m].raw;
                map.setView([ship.lat, ship.lon], Math.max(z, map.getZoom()));
            }
            else
                map.setView(marker_focus.getLatLng(), Math.max(z, map.getZoom()));
            shipcardMinIfMaxonMobile();
        }

        function shipcardVisible() {
            return document.getElementById('shipcard').classList.contains('visible');
        }

        async function showTrack() {

            marker_showtrack = true;
            updateTrack();
            shipcardMinIfMaxonMobile();
        }

        async function setStation() {

            if (card_mmsi == settings.center_point) {
                settings.center_point = "STATION";
            }
            else {
                settings.center_point = card_mmsi;
            }

            saveSettings();
            plotStation();
        }

        function removeTrack() {
            marker_showtrack = false;
            if (marker_track != null) map.removeLayer(marker_track);
            marker_track = null;

        }
        async function updateTrack() {

            if (card_mmsi in markers)
                if (marker_showtrack) {

                    try {
                        a = await fetch("path.json?" + card_mmsi);
                        path = await a.json()
                    }
                    catch (error) {
                        console.log("Error loading path: " + error);
                        return;
                    }

                    removeTrack();

                    marker_track = L.featureGroup().addTo(map);
                    for (var i = 0; i < Math.min(path.length, 250); i++) {
                        if (i > 0) {
                            var o = Math.max(0.25, 1 - path[i].received / (30 * 60));
                            if (true || path[i].received - path[i - 1].received > 300 || i == path.length - 1 || i == 249) {
                                var m = L.circleMarker([path[i].lat, path[i].lon], { opacity: o, color: '#12a5ed', radius: 1 }).addTo(map);
                                m.bindTooltip(getDeltaTimeVal(path[i].received) + " ago", { opacity: 0.85, permanent: false, offset: [15, 0], direction: 'right' });
                                marker_track.addLayer(m);
                            }

                            var l = new L.polyline([[path[i].lat, path[i].lon], [path[i - 1].lat, path[i - 1].lon]], { color: '#12a5ed', opacity: o });
                            marker_track.addLayer(l);
                        }
                    }

                    // assume track is more recent than entry in ShipsDB, to avoid elements not in sync
                    if (path.length > 0) markers[card_mmsi].setLatLng([path[0].lat, path[0].lon]);

                    //shipsDB[card_mmsi].raw.lat = path[0].lat;
                    //shipsDB[card_mmsi].raw.lon = path[0].lon;
                    //plotShip(shipsDB[card_mmsi].raw);

                    marker_showtrack = true;
                }
        }

        function isShipcardMax() {

            var e = document.getElementById('shipcard').classList;
            return e.contains('shipcard-ismax');
        }

        function clearFocusMarker() {
            if (marker_focus != null) {
                map.removeLayer(marker_focus);
                marker_focus = null;
            }
        }

        function setFocusMarker(latlon) {
            if (marker_focus == null) {
                marker_focus = L.circleMarker(latlon, { interactive: false, color: 'red', radius: 20, weight: 4, fillOpacity: 0, pane: "locationMarker", className: "pulse" });
                marker_focus.addTo(map);
            }
            else
                marker_focus.setLatLng(latlon);
        }

        function clearHoverMarker() {

            if (marker_hover != null) {
                map.removeLayer(marker_hover);
                marker_hover = null;
            }
        }

        function setHoverMarker(latlon) {

            if (marker_hover == null) {
                marker_hover = L.circleMarker(latlon, { interactive: false, color: 'orange', radius: 16, weight: 4, fillOpacity: 0, pane: "locationMarker" });
                marker_hover.addTo(map);
            }
            else
                marker_hover.setLatLng(latlon);
        }

        function getStringfromMsgType(m) {
            let s = "";
            let delim = "";
            for (i = 1; i <= 27; i++)
                if ((m & (1 << i)) != 0) {
                    s += delim + Number(i).toFixed(0);
                    delim = ", ";
                }
            return s;
        }

        function getStringfromChannels(m) {
            let s = "";
            let delim = "";
            for (i = 0; i <= 3; i++)
                if ((m & (1 << i)) != 0) {
                    s += delim + String.fromCharCode(65 + i);
                    delim = ", ";
                }
            return s;
        }

        function setShipcardValidation(v) {

            document.getElementById('shipcard_header').classList.remove("shipcard-validated", "shipcard-not-validated", "shipcard-dubious");

            switch (v) {
                case 1: document.getElementById('shipcard_header').classList.add("shipcard-validated"); break;
                case -1: document.getElementById('shipcard_header').classList.add("shipcard-dubious"); break;
                default: document.getElementById('shipcard_header').classList.add("shipcard-not-validated");
            }
        }

        function populateShipcard() {


            if (!(card_mmsi in shipsDB)) {

                document.getElementById('shipcard_content').querySelectorAll('span:nth-child(2)').forEach(e => e.innerHTML = null);
                document.getElementById('shipcard_header_title').innerHTML = "<b style='color:red;'>Out of range</b>";
                document.getElementById("shipcard_mmsi").innerHTML = card_mmsi;

                clearFocusMarker();
                removeTrack();

                return;
            }

            let ship = shipsDB[card_mmsi].raw;

            document.getElementById('shipcard_header_title').innerHTML = getFlag(ship.country) + (getShipName(ship) || ship.mmsi);

            setShipcardValidation(ship.validated);

            // verbatim copies
            ['destination', 'mmsi', 'count', 'imo'].forEach(e => document.getElementById('shipcard_' + e).innerHTML = ship[e]);

            // round and add units
            [{ id: "cog", u: "&deg", d: 0 },
            { id: "heading", u: "&deg", d: 0 },
            { id: "level", u: "dB", d: 1 },
            { id: "ppm", u: "ppm", d: 1 }
            ].forEach(el => document.getElementById("shipcard_" + el.id).innerHTML = ship[el.id] ? Number(ship[el.id]).toFixed(el.d) + " " + el.u : null);

            document.getElementById("shipcard_callsign").innerHTML = getCallSign(ship);
            document.getElementById("shipcard_msgtypes").innerHTML = getStringfromMsgType(ship.msg_type);
            document.getElementById("shipcard_channels").innerHTML = getStringfromChannels(ship.channels);
            document.getElementById('shipcard_type').innerHTML = getTypeVal(ship);
            document.getElementById('shipcard_shiptype').innerHTML = getShipTypeVal(ship.shiptype);
            document.getElementById("shipcard_status").innerHTML = getStatusVal(ship);
            document.getElementById("shipcard_last_signal").innerHTML = getDeltaTimeVal(ship.last_signal);
            document.getElementById("shipcard_eta").innerHTML = (ship.eta_month != null && ship.eta_hour != null && ship.eta_day != null && ship.eta_minute != null) ? getEtaVal(ship) : null;
            document.getElementById("shipcard_lat").innerHTML = ship.lat ? getLatVal(ship) : null;
            document.getElementById("shipcard_lon").innerHTML = ship.lon ? getLonVal(ship) : null;

            document.getElementById("shipcard_speed").innerHTML = ship.speed ? getSpeedVal(ship.speed) + " " + getSpeedUnit() : null;
            document.getElementById("shipcard_distance").innerHTML = ship.distance ? getDistanceVal(ship.distance) + " " + getDistanceUnit() : null;
            document.getElementById("shipcard_draught").innerHTML = ship.draught ? getDimensionVal(ship.draught) + " " + getDimensionUnit() : null;
            document.getElementById("shipcard_dimension").innerHTML = (ship.to_bow != null && ship.to_stern != null && ship.to_port != null && ship.to_starboard != null) ? getDimensionVal(ship.to_bow + ship.to_stern) + " " + getDimensionUnit() + " x " + getDimensionVal(ship.to_port + ship.to_starboard) + " " + getDimensionUnit() : null;
        }

        function shipcardMinIfMaxonMobile() {
            if (shipcardVisible() && window.matchMedia("(max-height: 1000px) and (max-width: 500px)").matches && isShipcardMax()) {
                toggleShipcardSize();
            }
        }

        function plotStation() {
            const hasStation = station == null || !station.hasOwnProperty("lat") || !station.hasOwnProperty("lon");
            const hasMMSIcenter = settings.center_point && settings.center_point != "STATION" && settings.center_point in shipsDB;

            // plot station on map
            if (hasStation) {
                if (marker_station) {
                    map.removeLayer(marker_station);
                    marker_station = null;
                }
            } else {
                if (marker_station == null) {
                    marker_station = L.circleMarker([station.lat, station.lon], { interactive: true, color: 'white', radius: 8, weight: 4, fillOpacity: 1, fillColor: 'red', pane: "locationMarker" })
                    marker_station.on('contextmenu', function (e) { showContextMenu(event, 0, ['station']); });
                    marker_station.addTo(map);
                }
                else {
                    marker_station.setLatLng([station.lat, station.lon]);
                }
            }

            // MMSI is driving center but does not exist
            if (!hasMMSIcenter && settings.center_point != "STATION") {
                settings.center_point = "STATION";
                settings.fix_center = false;
            }

            if (settings.center_point == "STATION") {
                center = station;
            }
            else {
                center = {};
                if (hasMMSIcenter) {
                    let ship = shipsDB[settings.center_point].raw;
                    if (ship.lat != null && ship.lon != null) {
                        center = { lat: ship.lat, lon: ship.lon };
                    }
                }
            }

            // plot the center on the map
            if (center == null || !center.hasOwnProperty("lat") || !center.hasOwnProperty("lon")) {
                if (marker_center) {
                    map.removeLayer(marker_center);
                    marker_center = null;
                }
            }
            else {
                if (marker_center == null) {
                    marker_center = L.circleMarker([center.lat, center.lon], { interactive: false, color: 'black', radius: 12, weight: 4, fillOpacity: 0, pane: "locationMarker" })
                    marker_center.addTo(map);
                }
                else {
                    marker_center.setLatLng([center.lat, center.lon]);
                }
            }

            if (settings.fix_center && center != null && center.hasOwnProperty("lat") && center.hasOwnProperty("lon")) {
                map.panTo([center.lat, center.lon]);
                settings.lat = center.lat;
                settings.lon = center.lon;
                saveSettings();
            }

            // update the menus with the latest center
            updateStationControl(center);
        }

        function showShipcard(m) {

            const aside = document.getElementById('shipcard');
            const visible = shipcardVisible();

            ship = m in shipsDB ? shipsDB[m].raw : null;
            ship_old = card_mmsi in shipsDB ? shipsDB[card_mmsi].raw : null;

            if (m != null && !visible) {
                aside.classList.toggle('visible');
            }
            else if (visible && m == null) {
                aside.classList.toggle('visible');
                clearFocusMarker();
            }

            if (m != card_mmsi || !shipcardVisible()) removeTrack();
            if (shipcardVisible()) setFocusMarker([ship.lat, ship.lon]);

            card_mmsi = m;

            if (ship != null) updateShipShape(ship);
            if (ship_old != null) updateShipShape(ship_old);

            if (shipcardVisible()) {
                populateShipcard();
                if (!map.getBounds().contains(marker_focus.getLatLng())) {
                    map.setView(marker_focus.getLatLng());
                }

                if (!visible) shipcardMinIfMaxonMobile();
            }

            updateTooltips();
        }

        async function updateMap() {

            const n = await fetchShips();

            if (n == 0) return;

            if (shipcardVisible()) populateShipcard();

            shipCanvas.clear();
            
            markers_set = [];
            markers = {}

            for (let [mmsi, entry] of Object.entries(shipsDB)) {
                let ship = entry.raw;
                if (ship.lat != null && ship.lon != null && ship.lat != 0 && ship.lon != 0 && ship.lat < 90 && ship.lon < 180) {
                    if (settings.setcoord) {
                        map.panTo(new L.LatLng(ship.lat, ship.lon));
                        settings.setcoord = false;
                    }
                    let icon = getIcon(ship);
                    markers[mmsi] = L.marker( [ship.lat, ship.lon], { icon });   
                    
                    markers[ship.mmsi].on('click', function (e) {  showShipcard(ship.mmsi); });
                    markers[ship.mmsi].on('mouseover', function (e) { startHover(ship.mmsi); });
                    markers[ship.mmsi].on('mouseout', function (e) { endHover(ship.mmsi); });
                    markers[ship.mmsi].on('contextmenu', function (e) { showContextMenu(event, ship.mmsi, ['mmsi', 'mmsi-map']); });
                    /*
                    markers[ship.mmsi].bindTooltip(getTooltipContent(ship), { opacity: 0.85, permanent: false, offset: [15, 0], direction: 'right' });
                    markers[ship.mmsi].closeTooltip();
                    */
                    markers_set.push(markers[mmsi]);
                    plotShip(ship);

                }
            }

            shipCanvas.addMarkers(markers_set);

            for (let [key, m] of Object.entries(markers)) {
                if (!shipsDB.hasOwnProperty(parseInt(key))) {
                    if (m != null) map.removeLayer(m);
                    delete markers[parseInt(key)];
                }
            }

            for (let [key, m] of Object.entries(ship_shape)) {
                if (!shipsDB.hasOwnProperty(parseInt(key))) {
                    if (m != null) map.removeLayer(m);
                    delete ship_shape[parseInt(key)];
                }
            }

            updateTooltips();

            if (card_mmsi != null && card_mmsi > 0 && markers[card_mmsi] != undefined) {
                setFocusMarker(markers[card_mmsi].getLatLng());
                updateTrack();
            }
            plotStation(station);
            plotRange();
        }

        function updateRangeControl() {
            iconRangeSpan.classList.remove('blue');
            iconRangeSpan.classList.remove('red');
            iconRangeSpan.classList.remove('grey');

            if (settings.show_range) {
                iconRangeSpan.classList.add('blue');
            }
            else {
                iconRangeSpan.classList.add('grey');
            }
        }

        function updateDarkMode() {
            const root = document.querySelector(":root");
            root.classList.remove("dark");

            if (settings.dark_mode) root.classList.toggle("dark");
            var icon = document.getElementById("darkmodetoggle-id");
            if (settings.dark_mode) {
                icon.classList.remove("fa-moon");
                icon.classList.add("fa-sun");

            } else {
                icon.classList.remove("fa-sun");
                icon.classList.add("fa-moon");
            }
        }

        function toggleDarkMode() {
            settings.dark_mode = !settings.dark_mode;
            updateDarkMode();
            saveSettings();
        }

        function refresh_data() {
            if (!document.hidden) {
                if (settings.tab == "map") {
                    updateMap();
                    map.invalidateSize();
                }
                else if (settings.tab == "stat") updateStatistics();
                else if (settings.tab == "plots") updatePlots();
                else if (settings.tab == "ships") updateShipTable();
            }
        }

        async function openFocus(m, z) {
            await fetchShips(false);

            selectMapTab(m);
            if (z) mapResetView(z);
            else mapResetView(13);

            showTrack();
        }

        function activateTab(b, a) {

            hideMenuifSmall();

            Array.from(document.getElementById("menubar").children).forEach(e => e.className = e.className.replace(" active", ""))
            Array.from(document.getElementById("menubar_mini").children).forEach(e => e.className = e.className.replace(" active", ""))

            tabcontent = document.getElementsByClassName("tabcontent");

            for (i = 0; i < tabcontent.length; i++)
                tabcontent[i].style.display = "none";

            document.getElementById(a).style.display = "block";

            document.getElementById(a + "_tab").className += " active";
            document.getElementById(a + "_tab_mini").className += " active";

            settings.tab = a;
            saveSettings();

            clearInterval(interval);
            refresh_data();
            interval = setInterval(refresh_data, refreshIntervalMs)
        }

        function selectMapTab(m) {

            document.getElementById('map_tab').click();
            if (m in shipsDB)
                showShipcard(m)
        }

        function selectTab() {
            if (settings.tab != "about" && settings.tab != "map" && settings.tab != "plots" && settings.tab != "ships" && settings.tab != "stat") {
                settings.tab = "stat";
                alert("Invalid tab specified");
            }
            document.getElementById(settings.tab + "_tab").click();
        }

        async function loadPlugins() {
            try {
                const response = await fetch('config.js');
                const config = await response.text();
                window.eval(config);

            } catch (error) {
                console.error(error);
                alert("Error loading plugins: " + error);
            }
        }

        // for overwrite and insert code where needed
        function main() {
            plugins_main.forEach(function (p) { p(); });
        }

        function init_preSettings() { }
        function init_postSettings() { }
        function init_postTabsInit() { }

        // add the default tile layers and overlay
        addTileLayer("OpenStreetMap", L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors' }));
        addTileLayer("Positron", L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', subdomains: 'abcd', maxZoom: 20 }));
        addTileLayer("Dark Matter", L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', subdomains: 'abcd', maxZoom: 20 }));
        addTileLayer("Voyager", L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>', subdomains: 'abcd', maxZoom: 20 }))
        addTileLayer("Satellite", L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community' }));

        addOverlayLayer("OpenSeaMap", L.tileLayer('http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png', { attribution: 'Map data: &copy; <a href="http://www.openseamap.org">OpenSeaMap</a> contributors', maxZoom: 18 }));

        let mdabout = "This content can be defined by the owner of the station";

        console.log("Starting plugin code")

    </script>

    <script src="config.js"></script>

    <script>
        console.log("Plugin loading completed, build string: " + build_string);

        init_preSettings();

        console.log("Load settings")
        loadSettings();

        console.log("Load settings from URL parameters")

        if (settings.loadURL)
            loadSettingsFromURL();

        init_postSettings();

        console.log("Setup tabs");
        initFullScreen();
        initPlots();
        initMap();
        addLabelControl();
        addStationControl();
        addRangeControl();
        updateDarkMode();

        init_postTabsInit();

        console.log("Switch to active tab");
        selectTab();

        let urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('mmsi'))
            openFocus(urlParams.get('mmsi'), urlParams.get('zoom'));

        saveSettings();

        fetchAbout().then(s => {
            document.getElementById("about_content").innerHTML = marked.parse(s);
        }).catch(error => {
            alert("Error loading about.md: " + error);
            aboutMDpresent = false;
        });
        if (aboutMDpresent == false) {
            document.getElementById("about_tab").style.display = "none";
            document.getElementById("about_tab_mini").style.display = "none";
        }

        
        main();

    </script>
</body>
</html>
